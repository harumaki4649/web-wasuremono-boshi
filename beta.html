<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>📚 忘れ物防止システム Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  // Tailwind CSS ダークモード設定
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        animation: {
          pulse: 'pulse 0.6s ease-in-out',
        },
        keyframes: {
          pulse: {
            '0%, 100%': { transform: 'scale(1)' },
            '50%': { transform: 'scale(1.03)' },
          }
        }
      }
    }
  }
  // ページの読み込み時にlocalStorageからテーマを反映
  if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.documentElement.classList.add('dark')
  } else {
    document.documentElement.classList.remove('dark')
  }
</script>
<meta name="theme-color" content="#3b82f6">

<style>
  /* QuaggaのビデオとキャンバスがTailwindのクラスで制御しにくいため、ここでスタイルを適用 */
  #viewport canvas, #viewport video,
  #check-viewport canvas, #check-viewport video {
    width: 100% !important;
    height: 100% !important;
    position: absolute;
    top: 0;
    left: 0;
    object-fit: cover;
  }
</style>

</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans transition-colors duration-300">
<div class="max-w-xl mx-auto p-2 sm:p-4">
<header class="text-white p-5 rounded-2xl shadow-lg text-center mb-4 bg-gradient-to-br from-blue-500 to-blue-700 dark:from-blue-600 dark:to-blue-800">
<h1 class="text-2xl sm:text-3xl font-bold">📚 忘れ物防止システム Pro</h1>
<p class="text-sm sm:text-base opacity-90 mt-1">教材・持ち物をまとめて管理！</p>
</header>

<nav class="flex bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm rounded-full shadow-md mb-4 p-1">
<button class="tab-btn flex-1 py-2 px-2 text-sm sm:text-base font-semibold text-gray-600 dark:text-gray-300 rounded-full transition-all duration-300" data-tab="quick">⚡<span class="hidden sm:inline-block ml-1">クイック</span></button>
<button class="tab-btn flex-1 py-2 px-2 text-sm sm:text-base font-semibold text-gray-600 dark:text-gray-300 rounded-full transition-all duration-300" data-tab="scanner">📱<span class="hidden sm:inline-block ml-1">登録</span></button>
<button class="tab-btn flex-1 py-2 px-2 text-sm sm:text-base font-semibold text-gray-600 dark:text-gray-300 rounded-full transition-all duration-300" data-tab="items">📋<span class="hidden sm:inline-block ml-1">一覧</span></button>
<button class="tab-btn flex-1 py-2 px-2 text-sm sm:text-base font-semibold text-gray-600 dark:text-gray-300 rounded-full transition-all duration-300" data-tab="check">✅<span class="hidden sm:inline-block ml-1">チェック</span></button>
<button class="tab-btn flex-1 py-2 px-2 text-sm sm:text-base font-semibold text-gray-600 dark:text-gray-300 rounded-full transition-all duration-300" data-tab="settings">⚙️<span class="hidden sm:inline-block ml-1">設定</span></button>
</nav>

<!-- クイックアクセスタブ -->
<div id="quick" class="tab-content">
<div class="grid grid-cols-3 gap-2 sm:gap-4 mb-4">
<div class="stat-card text-center p-3 bg-white dark:bg-gray-800 rounded-xl shadow-md">
<div class="stat-number text-2xl sm:text-3xl font-bold text-blue-600 dark:text-blue-400" id="total-items">0</div>
<div class="stat-label text-xs sm:text-sm text-gray-500 dark:text-gray-400 mt-1">総アイテム</div>
</div>
<div class="stat-card text-center p-3 bg-white dark:bg-gray-800 rounded-xl shadow-md">
<div class="stat-number text-2xl sm:text-3xl font-bold text-green-600 dark:text-green-400" id="checked-items">0</div>
<div class="stat-label text-xs sm:text-sm text-gray-500 dark:text-gray-400 mt-1">チェック済</div>
</div>
<div class="stat-card text-center p-3 bg-white dark:bg-gray-800 rounded-xl shadow-md">
<div class="stat-number text-2xl sm:text-3xl font-bold text-yellow-600 dark:text-yellow-400" id="today-items">0</div>
<div class="stat-label text-xs sm:text-sm text-gray-500 dark:text-gray-400 mt-1">今日の予定</div>
</div>
</div>

<div class="card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-5 mb-4">
<h3 class="text-lg font-bold mb-3 text-gray-800 dark:text-gray-100">🚀 クイック追加</h3>
<div class="flex flex-col sm:flex-row gap-2">
<input type="text" id="quick-name" placeholder="アイテム名を入力" class="base-input flex-grow">
<button id="quick-add" class="btn btn-success flex-shrink-0">➕ 追加</button>
</div>
<div class="mt-3 flex items-center gap-2">
<select id="quick-category" class="base-input flex-grow"></select>
<button id="quick-scan" class="btn btn-info btn-sm">📷 スキャン追加</button>
</div>
</div>

<div class="card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-5">
<h3 class="text-lg font-bold mb-3 text-gray-800 dark:text-gray-100">📅 今日のチェックリスト</h3>
<ul id="today-checklist" class="space-y-2"></ul>
</div>
</div>

<!-- スキャンタブ（登録用） -->
<div id="scanner" class="tab-content hidden">
<div class="card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-5 mb-4">
<div id="viewport" class="relative w-full h-64 bg-black rounded-lg overflow-hidden border-2 border-blue-500 dark:border-blue-400 mb-3"><div class="absolute inset-[20%_15%] border-4 border-dashed border-green-400 bg-green-400/10 rounded-lg pointer-events-none"></div></div>
<div id="status" class="text-center font-semibold p-3 rounded-lg mb-3 bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300">📷 準備完了 - スキャン開始ボタンを押してください</div>
<div class="flex justify-center gap-3">
<button id="scan-btn" class="btn btn-primary">🚀 スキャン開始</button>
<button id="stop-btn" class="btn btn-secondary" disabled>⏹ 停止</button>
</div>
</div>

<div class="card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-5">
<h3 class="text-lg font-bold mb-3 text-gray-800 dark:text-gray-100">📖 詳細登録</h3>
<div class="space-y-4">
  <div class="input-group">
    <label class="input-label">アイテム名 *</label>
    <input type="text" id="detail-name" placeholder="例: 数学の教科書" class="base-input">
  </div>
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <div class="input-group">
      <label class="input-label">カテゴリー</label>
      <select id="detail-category" class="base-input"></select>
    </div>
    <div class="input-group">
      <label class="input-label">重要度</label>
      <select id="detail-priority" class="base-input"></select>
    </div>
  </div>
  <div class="input-group">
    <label class="input-label">バーコード (任意)</label>
    <input type="text" id="detail-code" placeholder="バーコードまたは独自ID" class="base-input">
  </div>
  <div class="input-group">
    <label class="input-label">メモ (任意)</label>
    <textarea id="detail-memo" rows="2" placeholder="追加情報やメモ" class="base-input"></textarea>
  </div>
  <div class="input-group">
    <label class="input-label">必要な曜日</label>
    <div id="detail-days-container" class="grid grid-cols-4 sm:grid-cols-7 gap-2 text-sm"></div>
  </div>
  <button id="add-detail" class="btn btn-success w-full">➕ 詳細登録</button>
</div>
</div>
</div>

<!-- 一覧タブ -->
<div id="items" class="tab-content hidden">
<div class="card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-5 mb-4">
<div class="relative mb-3">
<input type="text" id="search-input" class="base-input pl-10" placeholder="🔍 アイテムを検索...">
<button id="search-clear" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hidden">×</button>
</div>
<div class="category-tabs flex flex-wrap gap-2" id="category-tabs"></div>
</div>

<div class="card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-5">
<h3 id="items-title" class="text-lg font-bold mb-3 text-gray-800 dark:text-gray-100">📚 全アイテム (0件)</h3>
<ul id="items-list" class="space-y-2"></ul>
<div class="flex justify-center items-center gap-3 mt-4">
<button id="sort-toggle" class="btn btn-secondary btn-sm">📊 並び替え</button>
<button id="clear-items" class="btn btn-danger btn-sm">🗑 全削除</button>
</div>
</div>
</div>

<!-- チェックタブ -->
<div id="check" class="tab-content hidden">
<div class="card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-5 mb-4">
<h3 class="text-lg font-bold mb-3 text-gray-800 dark:text-gray-100">✅ 曜日別チェックリスト</h3>
<div class="grid grid-cols-4 sm:grid-cols-7 gap-2" id="preset-days"></div>
</div>

<div class="card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-5">
<h3 class="text-lg font-bold mb-3 text-gray-800 dark:text-gray-100">📷 チェック方法選択</h3>
<div class="flex bg-gray-200 dark:bg-gray-700 rounded-full p-1 mb-4">
<button class="scan-mode-btn flex-1 py-1.5 text-sm font-semibold rounded-full" data-mode="manual">✋ 手動</button>
<button class="scan-mode-btn flex-1 py-1.5 text-sm font-semibold rounded-full" data-mode="scan">📱 スキャン</button>
</div>

<!-- 手動チェックモード -->
<div id="manual-check-mode">
<div id="check-progress" class="text-center my-4 font-semibold text-lg"></div>
<ul id="checklist" class="space-y-2"></ul>
<div class="flex justify-center gap-2 mt-4">
<button id="check-all" class="btn btn-success btn-sm">✅ 全選択</button>
<button id="uncheck-all" class="btn btn-warning btn-sm">⭕ 全解除</button>
<button id="reset-check" class="btn btn-secondary btn-sm">🔄 リセット</button>
</div>
</div>

<!-- スキャンチェックモード -->
<div id="scan-check-mode" class="hidden">
<div id="check-viewport" class="relative w-full h-64 bg-black rounded-lg overflow-hidden border-2 border-blue-500 dark:border-blue-400 mb-3"><div class="absolute inset-[20%_15%] border-4 border-dashed border-green-400 bg-green-400/10 rounded-lg pointer-events-none"></div></div>
<div id="check-status" class="text-center font-semibold p-3 rounded-lg mb-3 bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300">📷 バーコードを読み取って自動チェック</div>
<div class="flex justify-center gap-3">
<button id="check-scan-btn" class="btn btn-primary">🚀 スキャン開始</button>
<button id="check-stop-btn" class="btn btn-secondary" disabled>⏹ 停止</button>
</div>
<div id="check-result" class="check-result my-3 p-3 rounded-lg text-center font-semibold hidden"></div>

<div class="mt-4">
<div id="scan-check-progress" class="text-center mb-2 font-semibold text-lg"></div>
<ul id="scan-checklist" class="space-y-2"></ul>
<div class="flex justify-center gap-2 mt-4">
  <button id="scan-check-all" class="btn btn-success btn-sm">✅ 全選択</button>
  <button id="scan-uncheck-all" class="btn btn-warning btn-sm">⭕ 全解除</button>
  <button id="scan-reset-check" class="btn btn-secondary btn-sm">🔄 リセット</button>
</div>
</div>

<div class="mt-6">
<h4 class="text-md font-bold text-gray-800 dark:text-gray-100">📊 スキャン結果</h4>
<ul id="scan-results" class="space-y-2 mt-2"></ul>
</div>
</div>
</div>
</div>

<!-- 設定タブ -->
<div id="settings" class="tab-content hidden">
<div class="card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-5 mb-4">
<h3 class="text-lg font-bold mb-3 text-gray-800 dark:text-gray-100">🌙 テーマ設定</h3>
<div class="flex items-center justify-between">
<span>ダークモード</span>
<button id="theme-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-gray-700">
<span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span>
</button>
</div>
</div>

<div class="card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-5 mb-4">
<h3 class="text-lg font-bold mb-3 text-gray-800 dark:text-gray-100">📊 統計情報</h3>
<div class="grid grid-cols-2 gap-4" id="detailed-stats">
  <div class="stat-card text-center p-3 bg-gray-100 dark:bg-gray-700/50 rounded-lg">
    <div class="stat-number text-2xl font-bold text-blue-600 dark:text-blue-400" id="stat-total">0</div>
    <div class="stat-label text-sm text-gray-500 dark:text-gray-400 mt-1">総アイテム数</div>
  </div>
  <div class="stat-card text-center p-3 bg-gray-100 dark:bg-gray-700/50 rounded-lg">
    <div class="stat-number text-2xl font-bold text-purple-600 dark:text-purple-400" id="stat-categories">0</div>
    <div class="stat-label text-sm text-gray-500 dark:text-gray-400 mt-1">カテゴリー数</div>
  </div>
  <div class="stat-card text-center p-3 bg-gray-100 dark:bg-gray-700/50 rounded-lg">
    <div class="stat-number text-2xl font-bold text-indigo-600 dark:text-indigo-400" id="stat-barcodes">0</div>
    <div class="stat-label text-sm text-gray-500 dark:text-gray-400 mt-1">バーコード付き</div>
  </div>
  <div class="stat-card text-center p-3 bg-gray-100 dark:bg-gray-700/50 rounded-lg">
    <div class="stat-number text-2xl font-bold text-green-600 dark:text-green-400" id="stat-completion">0%</div>
    <div class="stat-label text-sm text-gray-500 dark:text-gray-400 mt-1">完了率</div>
  </div>
</div>
</div>

<div class="card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-5 mb-4">
<h3 class="text-lg font-bold mb-3 text-gray-800 dark:text-gray-100">⚙️ データ管理</h3>
<div class="grid grid-cols-2 gap-3 mb-3">
<button id="export-btn" class="btn btn-primary w-full">⬇ エクスポート</button>
<label for="import-file" class="btn btn-secondary w-full text-center cursor-pointer flex items-center justify-center">⬆ インポート</label>
</div>
<input type="file" id="import-file" class="hidden" accept="application/json">
<div class="grid grid-cols-2 gap-3">
<button id="backup-btn" class="btn btn-info w-full">💾 バックアップ</button>
<button id="restore-btn" class="btn btn-warning w-full">🔄 復元</button>
</div>
<div id="status-msg" class="mt-4 text-center font-semibold"></div>
</div>

<div class="card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-5">
<h3 class="text-lg font-bold mb-3 text-gray-800 dark:text-gray-100">📱 PWA情報</h3>
<p class="text-sm mb-3">このアプリはオフライン動作やホーム画面追加に対応しています。</p>
<button id="install-pwa" class="btn btn-success w-full hidden">📱 ホーム画面に追加</button>
</div>
</div>

<!-- 編集モーダル -->
<div id="edit-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
<div class="flex justify-between items-center mb-4">
<h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">✏️ アイテム編集</h3>
<button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200" onclick="closeEditModal()">
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
</button>
</div>
<div class="space-y-4">
    <div class="input-group">
        <label class="input-label">アイテム名</label>
        <input type="text" id="edit-name" class="base-input">
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div class="input-group">
          <label class="input-label">カテゴリー</label>
          <select id="edit-category" class="base-input"></select>
      </div>
      <div class="input-group">
          <label class="input-label">重要度</label>
          <select id="edit-priority" class="base-input"></select>
      </div>
    </div>
    <div class="input-group">
        <label class="input-label">バーコード</label>
        <input type="text" id="edit-code" class="base-input">
    </div>
    <div class="input-group">
        <label class="input-label">メモ</label>
        <textarea id="edit-memo" rows="2" class="base-input"></textarea>
    </div>
    <div class="input-group">
        <label class="input-label">必要な曜日</label>
        <div id="edit-days" class="grid grid-cols-4 sm:grid-cols-7 gap-2 text-sm"></div>
    </div>
    <div class="flex gap-3 mt-6">
        <button id="save-edit" class="btn btn-success w-full">💾 保存</button>
        <button onclick="closeEditModal()" class="btn btn-secondary w-full">❌ キャンセル</button>
    </div>
</div>
</div>
</div>

</div>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
// --- UTILITY CLASSES FOR JS ---
const C = {
  // Base styles
  baseInput: 'w-full p-2.5 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition',
  
  // Buttons
  btn: 'py-2 px-4 rounded-lg font-semibold transition-all duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-gray-900 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed',
  btnPrimary: 'bg-blue-600 text-white hover:bg-blue-700 focus-visible:ring-blue-500',
  btnSecondary: 'bg-gray-500 text-white hover:bg-gray-600 focus-visible:ring-gray-400',
  btnSuccess: 'bg-green-600 text-white hover:bg-green-700 focus-visible:ring-green-500',
  btnDanger: 'bg-red-600 text-white hover:bg-red-700 focus-visible:ring-red-500',
  btnWarning: 'bg-yellow-500 text-white hover:bg-yellow-600 focus-visible:ring-yellow-400',
  btnInfo: 'bg-sky-500 text-white hover:bg-sky-600 focus-visible:ring-sky-400',
  btnSm: 'py-1.5 px-3 text-sm',
  
  // Statuses
  statusBase: 'p-3 rounded-lg text-center font-semibold',
  statusSuccess: 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300',
  statusWarning: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300',
  statusError: 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300',
  statusInfo: 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300',

  // Items
  itemBase: 'flex items-center p-3 border-l-4 rounded-lg shadow-sm transition-all duration-300',
  itemDefault: 'bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600',
  itemChecked: 'bg-green-50 dark:bg-green-900/40 border-green-500 dark:border-green-600',
  itemScanned: 'animate-pulse bg-blue-50 dark:bg-blue-900/40 border-blue-500 dark:border-blue-600',
  itemPrioHigh: 'border-red-500 dark:border-red-400',
  itemPrioMid: 'border-yellow-500 dark:border-yellow-400',
  
  // Category buttons
  catBtn: 'py-1.5 px-4 rounded-full text-sm font-semibold cursor-pointer transition-colors duration-200',
  catBtnInactive: 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600',
  catBtnActive: 'bg-blue-600 dark:bg-blue-500 text-white shadow-md',
};

// --- GLOBAL OPTIONS ---
const CATEGORIES = {
  '教材': '📚', '文房具': '✏️', '体育用品': '⚽', '弁当・水筒': '🍱',
  '制服・服装': '👔', '楽器': '🎵', '部活用品': '🏃', 'その他': '📦'
};
const PRIORITIES = { '普通': 1, '重要': 2, '必須': 3 };
const DAYS = ['月', '火', '水', '木', '金', '土', '日'];


// PWA設定
const manifestData = {
  "name": "忘れ物防止システム Pro", "short_name": "忘れ物Pro",
  "description": "教材・持ち物を統合管理する忘れ物防止システム", "start_url": ".", "display": "standalone",
  "background_color": "#f3f4f6", "theme_color": "#3b82f6", "orientation": "portrait",
  "icons": [
    { "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABlBMVEUAAAD///+l2Z/dAAAAAnRSTlMAAQGU/a4AAAAJcEhZcwAALiMAAC4jAXilP3YAAAGkSURBVHja7doxAQAhDEBBEf+FwUDeoQJ23gCST1J2YAB2YAe2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAd2YAe2bwAByuA+1dM1kQAAAABJRU5ErkJggg==", "sizes": "192x192", "type": "image/png" },
    { "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eZ5XAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABlBMVEUAAAD///+l2Z/dAAAAAnRSTlMAAQGU/a4AAAAJcEhZcwAALiMAAC4jAXilP3YAAAIkSURBVHja7dMBAQAADAzAppContextqCAAwL8EIgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgD2AZdAAAE21E0dAAAAAElFTkSuQmCC", "sizes": "512x512", "type": "image/png" }
  ]
};
const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(manifestBlob);
const link = document.createElement('link'); link.rel = 'manifest'; link.href = manifestURL; document.head.appendChild(link);

// Service Worker登録
const swCode = `const CACHE_NAME='wasuremono-pro-v3.0';const urlsToCache=['./','https://unpkg.com/quagga@0.12.1/dist/quagga.min.js'];self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(urlsToCache).catch(()=>c.add('./')))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).catch(()=>caches.match('./')))));`;
if ('serviceWorker' in navigator) { const swBlob = new Blob([swCode], {type: 'application/javascript'}); const swURL = URL.createObjectURL(swBlob); navigator.serviceWorker.register(swURL); }

// IndexedDB設定
const DB_NAME = 'wasuremonoPro'; const DB_VERSION = 2; const STORE_NAME = 'items'; let db;
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onerror = () => reject(request.error);
    request.onsuccess = () => { db = request.result; resolve(db); };
    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        store.createIndex('category', 'category', { unique: false });
        store.createIndex('name', 'name', { unique: false });
        store.createIndex('code', 'code', { unique: false });
      }
    };
  });
}
function addItem(item) { return new Promise((resolve, reject) => { const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).add(item).onsuccess = e => resolve(e.target.result); tx.onerror = () => reject(tx.error); }); }
function getAllItems() { return new Promise((resolve, reject) => { const tx = db.transaction(STORE_NAME, 'readonly'); tx.objectStore(STORE_NAME).getAll().onsuccess = e => resolve(e.target.result); tx.onerror = () => reject(tx.error); }); }
function updateItem(item) { return new Promise((resolve, reject) => { const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).put(item).onsuccess = resolve; tx.onerror = () => reject(tx.error); }); }
function deleteItem(id) { return new Promise((resolve, reject) => { const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).delete(id).onsuccess = resolve; tx.onerror = () => reject(tx.error); }); }
function clearItemsDB() { return new Promise((resolve, reject) => { const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).clear().onsuccess = resolve; tx.onerror = () => reject(tx.error); }); }

// グローバル変数
let items = []; let currentDay = null; let currentCategory = 'all'; let sortBy = 'priority'; let isScanning = false; let isCheckScanning = false; let editingItem = null; let checkMode = 'manual'; let scanResults = new Map();

// UI要素
const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);

// タブ切り替え
$$('.tab-btn').forEach(tab => {
  tab.addEventListener('click', () => {
    $$('.tab-btn').forEach(t => t.classList.remove('active-tab-btn'));
    tab.classList.add('active-tab-btn');
    const target = tab.dataset.tab;
    $$('.tab-content').forEach(tc => tc.classList.toggle('hidden', tc.id !== target));
    
    updateActiveTabStyle();
    
    if (target === 'quick') { updateStats(); renderTodayChecklist(); } 
    else if (target === 'items') { renderItems(); }
    else if (target === 'check') { if (!currentDay) selectCurrentDay(); updateCheckDisplay(); }
    else if (target === 'settings') { updateDetailedStats(); }
    
    // スキャナーの停止
    if (isScanning && target !== 'scanner') stopScanning();
    if (isCheckScanning && target !== 'check') stopCheckScanning();
  });
});
function updateActiveTabStyle(){
    $$('.tab-btn').forEach(t => {
        t.classList.remove('bg-white', 'dark:bg-gray-900/80', 'shadow-md', 'text-blue-600', 'dark:text-blue-400');
        if (t.classList.contains('active-tab-btn')) {
            t.classList.add('bg-white', 'dark:bg-gray-900/80', 'shadow-md', 'text-blue-600', 'dark:text-blue-400');
        }
    });
}

// スキャンモード切り替え
$$('.scan-mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    $$('.scan-mode-btn').forEach(b => b.classList.remove('bg-white', 'dark:bg-gray-800', 'text-blue-600', 'dark:text-blue-400', 'shadow'));
    btn.classList.add('bg-white', 'dark:bg-gray-800', 'text-blue-600', 'dark:text-blue-400', 'shadow');
    checkMode = btn.dataset.mode;
    
    $('#manual-check-mode').classList.toggle('hidden', checkMode !== 'manual');
    $('#scan-check-mode').classList.toggle('hidden', checkMode !== 'scan');
    
    if (checkMode === 'manual' && isCheckScanning) stopCheckScanning();
    if (checkMode === 'scan') updateCheckDisplay();
  });
});

// 統計更新
function updateStats() {
  const total = items.length;
  const checked = items.filter(i => i.checked).length;
  const today = getTodayItems().length;
  $('#total-items').textContent = total;
  $('#checked-items').textContent = checked;
  $('#today-items').textContent = today;
}

function updateDetailedStats() {
  const total = items.length;
  const categories = [...new Set(items.map(i => i.category))].length;
  const barcodes = items.filter(i => i.code).length;
  const checked = items.filter(i => i.checked).length;
  const completion = total > 0 ? Math.round((checked / total) * 100) : 0;
  $('#stat-total').textContent = total;
  $('#stat-categories').textContent = categories;
  $('#stat-barcodes').textContent = barcodes;
  $('#stat-completion').textContent = completion + '%';
}

function getTodayItems() {
  const days = ['日', '月', '火', '水', '木', '金', '土'];
  const today = days[new Date().getDay()];
  return items.filter(i => i.days.includes(today));
}

function renderTodayChecklist() {
  const list = $('#today-checklist');
  const todayItems = getTodayItems().sort((a,b) => (PRIORITIES[b.priority] || 1) - (PRIORITIES[a.priority] || 1));
  list.innerHTML = todayItems.length === 0 
    ? `<li class="text-center text-gray-500 py-8">今日の予定はありません</li>`
    : todayItems.map(item => createItemElement(item, true).outerHTML).join('');
  attachEventListeners(list);
}

function createItemElement(item, isQuickView = false) {
  const li = document.createElement('li');
  li.className = `${C.itemBase} ${C.itemDefault}`;
  li.dataset.id = item.id;

  if (item.checked) li.classList.replace(C.itemDefault, C.itemChecked);
  if (item.priority === '必須') li.classList.add(C.itemPrioHigh);
  else if (item.priority === '重要') li.classList.add(C.itemPrioMid);

  const priorityIcon = item.priority === '必須' ? '‼️ ' : item.priority === '重要' ? '⭐ ' : '';
  const categoryIcon = CATEGORIES[item.category] || '📦';
  
  const mainContent = `
    <div class="flex-shrink-0 mr-3">
      <input type="checkbox" class="item-checkbox h-6 w-6 rounded-md border-gray-300 text-blue-600 focus:ring-blue-500" ${item.checked ? 'checked' : ''}>
    </div>
    <div class="flex-grow">
      <div class="font-bold text-gray-800 dark:text-gray-100">${priorityIcon}${item.name}</div>
      <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 flex flex-wrap gap-x-2">
        <span>${categoryIcon} ${item.category}</span>
        ${item.code ? `<span>#️⃣ ${item.code}</span>` : ''}
        ${item.days.length > 0 ? `<span>📅 ${item.days.join(', ')}</span>` : ''}
      </div>
      ${item.memo ? `<div class="text-xs text-gray-600 dark:text-gray-300 mt-1">${item.memo}</div>` : ''}
    </div>`;

  const actions = `
    <div class="flex-shrink-0 flex gap-2 ml-2">
      <button class="btn-edit p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
        <svg class="w-5 h-5 text-sky-600 dark:text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"/></svg>
      </button>
      <button class="btn-delete p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
        <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
      </button>
    </div>`;
  
  li.innerHTML = mainContent + (isQuickView ? '' : actions);
  return li;
}

function attachEventListeners(parent) {
    parent.querySelectorAll('.item-checkbox').forEach(cb => cb.addEventListener('change', handleCheck));
    parent.querySelectorAll('.btn-edit').forEach(btn => btn.addEventListener('click', handleEdit));
    parent.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', handleDelete));
}
async function handleCheck(e) {
    const li = e.target.closest('li');
    const item = items.find(i => i.id == li.dataset.id);
    if (!item) return;
    item.checked = e.target.checked;
    await updateItem(item);
    if (e.target.checked && navigator.vibrate) navigator.vibrate(50);
    rerenderAllViews();
}
function handleEdit(e) {
    const li = e.target.closest('li');
    const item = items.find(i => i.id == li.dataset.id);
    if (item) openEditModal(item);
}
async function handleDelete(e) {
    const li = e.target.closest('li');
    const item = items.find(i => i.id == li.dataset.id);
    if (item && confirm(`「${item.name}」を削除しますか？`)) {
        await deleteItem(item.id);
        items = items.filter(i => i.id !== item.id);
        showStatus('🗑 削除しました', 'success');
        rerenderAllViews();
    }
}

// ステータス表示
function showStatus(message, type = 'info') {
  const statusEl = $('#status-msg');
  if(!statusEl) return;
  const statusClasses = {
      success: C.statusSuccess, warning: C.statusWarning,
      error: C.statusError, info: C.statusInfo
  };
  statusEl.textContent = message;
  statusEl.className = `${C.statusBase} ${statusClasses[type]}`;
  setTimeout(() => {
    statusEl.textContent = '';
    statusEl.className = 'mt-4 text-center font-semibold';
  }, 3000);
}

function updateCheckDisplay() {
  if (!currentDay) return;
  renderChecklist(currentDay, '#checklist', '#check-progress');
  renderChecklist(currentDay, '#scan-checklist', '#scan-check-progress');
}

function renderChecklist(day, listSelector, progressSelector) {
  const list = $(listSelector);
  const progress = $(progressSelector);
  
  const filtered = items.filter(i => i.days.includes(day))
    .sort((a,b) => (PRIORITIES[b.priority] || 1) - (PRIORITIES[a.priority] || 1));
  
  if (filtered.length === 0) {
    list.innerHTML = `<li class="text-center text-gray-500 py-8">${day}曜日のアイテムはありません</li>`;
    progress.innerHTML = ''; return;
  }
  
  const checkedCount = filtered.filter(i => i.checked).length;
  const totalCount = filtered.length;
  const percentage = Math.round((checkedCount / totalCount) * 100);
  const isComplete = checkedCount === totalCount;
  
  progress.innerHTML = `<div class="${isComplete ? 'text-green-600 dark:text-green-400' : 'text-blue-600 dark:text-blue-400'}">
      ${day}曜日: ${checkedCount}/${totalCount} 完了 (${percentage}%) ${isComplete ? '🎉' : ''}</div>`;
      
  list.innerHTML = filtered.map(item => createItemElement(item, true).outerHTML).join('');
  attachEventListeners(list);
}


$('#quick-add').addEventListener('click', async () => {
  const name = $('#quick-name').value.trim();
  const category = $('#quick-category').value;
  if (!name) { $('#quick-name').focus(); return; }
  
  const daysOfWeek = ['日', '月', '火', '水', '木', '金', '土'];
  const today = daysOfWeek[new Date().getDay()];
  
  const success = await addNewItem({
    name, category, priority: '普通', days: [today], code: '', memo: ''
  });
  
  if (success) {
    $('#quick-name').value = '';
    showStatus(`✅ 「${name}」を追加しました`, 'success');
    rerenderAllViews();
  }
});
$('#quick-name').addEventListener('keypress', e => { if (e.key === 'Enter') $('#quick-add').click(); });
$('#quick-scan').addEventListener('click', () => {
  $$('.tab-btn')[1].click();
  setTimeout(() => { if (!isScanning) $('#scan-btn').click(); }, 300);
});

async function addNewItem(itemData) {
  if (!itemData.name.trim()) return false;
  
  if (itemData.code && items.some(i => i.code === itemData.code)) {
    showStatus('同じバーコードのアイテムが既に登録されています', 'warning'); return false;
  }
  
  const item = {
    name: itemData.name.trim(), category: itemData.category || 'その他',
    priority: itemData.priority || '普通', code: itemData.code ? itemData.code.trim() : '',
    memo: itemData.memo ? itemData.memo.trim() : '', days: itemData.days || [],
    checked: false, createdAt: new Date().toISOString()
  };
  
  try {
    item.id = await addItem(item);
    items.push(item);
    return true;
  } catch (err) {
    showStatus('追加に失敗しました', 'error');
    return false;
  }
}

$('#add-detail').addEventListener('click', async () => {
  const name = $('#detail-name').value;
  const category = $('#detail-category').value;
  const priority = $('#detail-priority').value;
  const code = $('#detail-code').value;
  const memo = $('#detail-memo').value;
  const days = Array.from($$('#detail-days-container input:checked')).map(cb => cb.value);
  
  if (!name.trim()) {
    $('#detail-name').focus(); showStatus('アイテム名を入力してください', 'warning'); return;
  }
  
  const success = await addNewItem({ name, category, priority, code, memo, days });
  if (success) {
    $('#detail-name').value = ''; $('#detail-code').value = ''; $('#detail-memo').value = '';
    $$('#detail-days-container input').forEach(cb => cb.checked = false);
    showStatus(`✅ 「${name}」を登録しました`, 'success');
    rerenderAllViews();
  }
});

const quaggaConfig = {
  inputStream: { name: 'Live', type: 'LiveStream', constraints: { facingMode: 'environment' }, willReadFrequently: true },
  frequency: 10, numOfWorkers: navigator.hardwareConcurrency || 4,
  decoder: { readers: ['ean_reader', 'ean_8_reader', 'code_128_reader'], multiple: false },
  locate: true,
};
function onDetected(result) {
  const code = result.codeResult.code;
  if (!code) return;
  Quagga.pause();
  if (items.find(i => i.code === code)) {
    showStatus(`✅ 既に登録済みです`, 'info');
  } else {
    $('#detail-code').value = code; $('#detail-name').focus();
    showStatus(`📖 検出: ${code}`, 'success');
  }
  if(navigator.vibrate) navigator.vibrate(100);
  setTimeout(() => Quagga.start(), 1500);
}

function onCheckDetected(result) {
  const code = result.codeResult.code;
  if (!code) return;
  Quagga.pause();
  
  const dayItems = items.filter(i => i.days.includes(currentDay));
  const foundItem = dayItems.find(i => i.code === code);
  const resultEl = $('#check-result');
  
  if (foundItem) {
    if (!foundItem.checked) {
      foundItem.checked = true; updateItem(foundItem); rerenderAllViews();
      scanResults.set(code, { item: foundItem, timestamp: new Date(), status: 'checked' });
      resultEl.innerHTML = `✅ <strong>${foundItem.name}</strong> をチェックしました`;
      resultEl.className = `${C.statusSuccess} ${C.statusBase}`;
      if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
    } else {
      resultEl.innerHTML = `ℹ️ 既にチェック済み: ${foundItem.name}`;
      resultEl.className = `${C.statusWarning} ${C.statusBase}`;
    }
  } else {
    resultEl.innerHTML = `❌ 未登録または今日のアイテムではありません`;
    resultEl.className = `${C.statusError} ${C.statusBase}`;
    if(navigator.vibrate) navigator.vibrate(200);
  }
  
  resultEl.classList.remove('hidden');
  renderScanResults();
  setTimeout(() => { Quagga.start(); resultEl.classList.add('hidden'); }, 2000);
}

function startScanning() {
  if (isScanning) return;
  $('#status').textContent = '🔧 カメラ初期化中...';
  Quagga.init({...quaggaConfig, inputStream: {...quaggaConfig.inputStream, target: $('#viewport')}}, err => {
    if (err) { $('#status').textContent = `❌ カメラエラー`; return; }
    Quagga.start(); isScanning = true; Quagga.onDetected(onDetected);
    $('#status').textContent = '🔍 バーコードを緑枠に合わせてください';
    $('#scan-btn').disabled = true; $('#stop-btn').disabled = false;
  });
}
function stopScanning() {
  if (!isScanning) return;
  Quagga.offDetected(onDetected); Quagga.stop(); isScanning = false;
  $('#status').textContent = '⏹ スキャン停止';
  $('#scan-btn').disabled = false; $('#stop-btn').disabled = true;
}

function startCheckScanning() {
  if (isCheckScanning) return;
  $('#check-status').textContent = '🔧 カメラ初期化中...';
  Quagga.init({...quaggaConfig, inputStream: {...quaggaConfig.inputStream, target: $('#check-viewport')}}, err => {
    if (err) { $('#check-status').textContent = `❌ カメラエラー`; return; }
    Quagga.start(); isCheckScanning = true; Quagga.onDetected(onCheckDetected);
    $('#check-status').textContent = '🔍 バーコードを緑枠に合わせてください';
    $('#check-scan-btn').disabled = true; $('#check-stop-btn').disabled = false;
  });
}
function stopCheckScanning() {
  if (!isCheckScanning) return;
  Quagga.offDetected(onCheckDetected); Quagga.stop(); isCheckScanning = false;
  $('#check-status').textContent = '⏹ スキャン停止';
  $('#check-scan-btn').disabled = false; $('#check-stop-btn').disabled = true;
}

$('#scan-btn').addEventListener('click', startScanning);
$('#stop-btn').addEventListener('click', stopScanning);
$('#check-scan-btn').addEventListener('click', startCheckScanning);
$('#check-stop-btn').addEventListener('click', stopCheckScanning);

function renderScanResults() {
  const list = $('#scan-results');
  const sorted = Array.from(scanResults.values()).sort((a,b) => b.timestamp - a.timestamp);
  list.innerHTML = sorted.length === 0
    ? `<li class="text-center text-gray-500 py-4">スキャン結果なし</li>`
    : sorted.map(res => `<li class="${C.itemBase} ${C.itemScanned}">${res.status === 'checked' ? '✅' : '❌'} <span class="ml-3 font-semibold">${res.item.name}</span></li>`).join('');
}

function renderItems() {
  let filtered = items;
  if (currentCategory !== 'all') filtered = filtered.filter(i => i.category === currentCategory);
  
  const searchTerm = $('#search-input').value.toLowerCase();
  if (searchTerm) {
    filtered = filtered.filter(i => 
      ['name', 'category', 'code', 'memo'].some(key => i[key]?.toLowerCase().includes(searchTerm))
    );
  }
  
  filtered.sort((a, b) => {
    if (sortBy === 'name') return a.name.localeCompare(b.name, 'ja');
    if (sortBy === 'category') return a.category.localeCompare(b.category, 'ja');
    if (sortBy === 'priority') return (PRIORITIES[b.priority] || 1) - (PRIORITIES[a.priority] || 1);
    if (sortBy === 'created') return new Date(b.createdAt) - new Date(a.createdAt);
    return 0;
  });
  
  $('#items-title').textContent = `${CATEGORIES[currentCategory] || '📚'} ${currentCategory === 'all' ? '全アイテム' : currentCategory} (${filtered.length}件)`;
  const list = $('#items-list');
  list.innerHTML = filtered.length === 0
    ? `<li class="text-center text-gray-500 py-8">該当するアイテムがありません</li>`
    : filtered.map(item => createItemElement(item).outerHTML).join('');
  attachEventListeners(list);
}

$('#category-tabs').addEventListener('click', e => {
  if (e.target.dataset.category) {
    currentCategory = e.target.dataset.category;
    renderItems(); updateCategoryTabs();
  }
});
$('#search-input').addEventListener('input', () => {
  renderItems();
  $('#search-clear').classList.toggle('hidden', !$('#search-input').value);
});
$('#search-clear').addEventListener('click', () => {
  $('#search-input').value = ''; renderItems(); $('#search-clear').classList.add('hidden');
});
$('#sort-toggle').addEventListener('click', () => {
  const sorts = ['priority', 'name', 'category', 'created'];
  sortBy = sorts[(sorts.indexOf(sortBy) + 1) % sorts.length];
  const labels = { priority: '重要度順', name: '名前順', category: 'カテゴリー順', created: '追加日順' };
  $('#sort-toggle').textContent = `📊 ${labels[sortBy]}`;
  renderItems();
});

function selectCurrentDay() {
  const days = ['日', '月', '火', '水', '木', '金', '土'];
  currentDay = days[new Date().getDay()];
  updatePresetDayButtons();
  updateCheckDisplay();
}

$('#preset-days').addEventListener('click', e => {
  const btn = e.target.closest('button');
  if (btn && btn.dataset.day) {
    currentDay = btn.dataset.day;
    updatePresetDayButtons(); updateCheckDisplay(); scanResults.clear(); renderScanResults();
  }
});

async function performCheckAll(checkState = true) {
  const dayItems = items.filter(i => i.days.includes(currentDay));
  for (const item of dayItems) {
    if (item.checked !== checkState) {
      item.checked = checkState; await updateItem(item);
    }
  }
  if (checkState && navigator.vibrate) navigator.vibrate(100);
  rerenderAllViews();
}
async function performResetCheck() {
  if (confirm('全てのアイテムのチェック状態をリセットしますか？')) {
    for (const item of items) item.checked = false;
    await Promise.all(items.map(item => updateItem(item)));
    rerenderAllViews(); scanResults.clear(); renderScanResults();
    showStatus('🔄 チェック状態をリセットしました', 'success');
  }
}
['check-all', 'scan-check-all'].forEach(id => $('#' + id).addEventListener('click', () => performCheckAll(true)));
['uncheck-all', 'scan-uncheck-all'].forEach(id => $('#' + id).addEventListener('click', () => performCheckAll(false)));
['reset-check', 'scan-reset-check'].forEach(id => $('#' + id).addEventListener('click', performResetCheck));

function openEditModal(item) {
  editingItem = item;
  $('#edit-name').value = item.name; $('#edit-category').value = item.category;
  $('#edit-priority').value = item.priority; $('#edit-code').value = item.code || '';
  $('#edit-memo').value = item.memo || '';
  $('#edit-days').querySelectorAll('input').forEach(cb => cb.checked = item.days.includes(cb.value));
  $('#edit-modal').classList.remove('hidden');
}
function closeEditModal() { $('#edit-modal').classList.add('hidden'); editingItem = null; }
$('#save-edit').addEventListener('click', async () => {
  if (!editingItem) return;
  editingItem.name = $('#edit-name').value.trim();
  if (!editingItem.name) { showStatus('アイテム名を入力してください', 'warning'); return; }
  editingItem.category = $('#edit-category').value; editingItem.priority = $('#edit-priority').value;
  editingItem.code = $('#edit-code').value.trim(); editingItem.memo = $('#edit-memo').value.trim();
  editingItem.days = Array.from($('#edit-days input:checked')).map(cb => cb.value);
  
  await updateItem(editingItem);
  rerenderAllViews(); closeEditModal();
  showStatus('✅ 更新しました', 'success');
});

$('#clear-items').addEventListener('click', async () => {
  if (confirm('本当に全てのアイテムを削除しますか？\nこの操作は取り消せません。')) {
    await clearItemsDB(); items = [];
    rerenderAllViews(); scanResults.clear(); renderScanResults();
    showStatus('🗑 全てのアイテムを削除しました', 'success');
  }
});

$('#export-btn').addEventListener('click', async () => {
    const allItems = await getAllItems();
    const dataStr = JSON.stringify({ items: allItems }, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `wasuremono_pro_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click(); URL.revokeObjectURL(a.href);
});
$('#import-file').addEventListener('change', async e => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = async () => {
    try {
      const data = JSON.parse(reader.result);
      if (!Array.isArray(data.items)) throw new Error('Invalid format');
      if (confirm(`${data.items.length}件をインポートしますか？\n(現在のデータは上書きされます)`)) {
        await clearItemsDB();
        for (const item of data.items) { delete item.id; await addItem(item); }
        await loadItems();
        showStatus(`✅ ${data.items.length}件インポートしました`, 'success');
      }
    } catch (err) { showStatus('インポート失敗', 'error'); }
  };
  reader.readAsText(file); e.target.value = '';
});

let deferredPrompt;
const installBtn = $('#install-pwa');
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden'); });
installBtn.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') installBtn.classList.add('hidden');
    deferredPrompt = null;
  }
});

$('#theme-toggle').addEventListener('click', () => {
  const isDark = document.documentElement.classList.toggle('dark');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
});

function initUI() {
    // Populate selects
    const catOptions = Object.entries(CATEGORIES).map(([name, icon]) => `<option value="${name}">${icon} ${name}</option>`).join('');
    $$('#quick-category, #detail-category, #edit-category').forEach(sel => sel.innerHTML = catOptions);
    
    const prioOptions = Object.keys(PRIORITIES).map(p => {
        const icon = p === '必須' ? '‼️ ' : p === '重要' ? '⭐ ' : '';
        return `<option value="${p}">${icon}${p}</option>`;
    }).join('');
    $$('#detail-priority, #edit-priority').forEach(sel => sel.innerHTML = prioOptions);

    // Populate day checkboxes
    const dayCheckboxes = DAYS.map(day => `<label class="flex items-center gap-1 p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600"><input type="checkbox" value="${day}" class="h-4 w-4 rounded text-blue-600 focus:ring-blue-500"> ${day}</label>`).join('');
    $$('#detail-days-container, #edit-days').forEach(div => div.innerHTML = dayCheckboxes);
    
    // Add base classes
    $$('.base-input').forEach(el => el.className = C.baseInput);
    $$('.btn').forEach(el => {
        let cls = C.btn + ' ';
        if (el.classList.contains('btn-primary')) cls += C.btnPrimary;
        if (el.classList.contains('btn-secondary')) cls += C.btnSecondary;
        if (el.classList.contains('btn-success')) cls += C.btnSuccess;
        if (el.classList.contains('btn-danger')) cls += C.btnDanger;
        if (el.classList.contains('btn-warning')) cls += C.btnWarning;
        if (el.classList.contains('btn-info')) cls += C.btnInfo;
        if (el.classList.contains('btn-sm')) cls += C.btnSm;
        el.className = cls;
    });
    
    // Day preset buttons
    const dayButtons = DAYS.map(day => `<button data-day="${day}" class="preset-btn py-2 px-3 text-sm font-semibold rounded-lg transition-colors duration-200 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200">${day}</button>`).join('');
    $('#preset-days').innerHTML = dayButtons;
    
    updateCategoryTabs();
}

function updateCategoryTabs() {
    const cats = ['all', ...Object.keys(CATEGORIES)];
    const catButtons = cats.map(cat => {
        const isActive = cat === currentCategory;
        const icon = cat === 'all' ? '🌐' : CATEGORIES[cat];
        return `<button data-category="${cat}" class="${C.catBtn} ${isActive ? C.catBtnActive : C.catBtnInactive}">${icon} <span class="${cat.length > 3 ? 'hidden sm:inline' : 'inline'}">${cat === 'all' ? '全て' : cat}</span></button>`;
    }).join('');
    $('#category-tabs').innerHTML = catButtons;
}

function updatePresetDayButtons() {
    $$('.preset-btn').forEach(btn => {
        btn.classList.toggle('bg-blue-600', btn.dataset.day === currentDay);
        btn.classList.toggle('text-white', btn.dataset.day === currentDay);
        btn.classList.toggle('dark:bg-blue-500', btn.dataset.day === currentDay);
        btn.classList.toggle('bg-gray-200', btn.dataset.day !== currentDay);
        btn.classList.toggle('dark:bg-gray-700', btn.dataset.day !== currentDay);
    });
}

function rerenderAllViews() {
  const activeTab = $('.tab-btn.active-tab-btn')?.dataset.tab || 'quick';
  if (activeTab === 'quick') renderTodayChecklist();
  if (activeTab === 'items') renderItems();
  if (activeTab === 'check') updateCheckDisplay();
  
  if ($('#today-checklist')) renderTodayChecklist(); // クイックタブ以外でも更新されるように
  updateStats();
  updateDetailedStats();
}

async function loadItems() {
  try {
    items = await getAllItems();
    rerenderAllViews();
  } catch (err) { console.error('Load items failed:', err); }
}

// 初期化
document.addEventListener('DOMContentLoaded', async () => {
    initUI();
    $$('.tab-btn')[0].classList.add('active-tab-btn');
    updateActiveTabStyle();
    $$('.scan-mode-btn')[0].classList.add('bg-white', 'dark:bg-gray-800', 'text-blue-600', 'dark:text-blue-400', 'shadow');
    
    await openDB();
    await loadItems();
    selectCurrentDay();
  
    if (items.length === 0) {
      setTimeout(() => { showStatus('👋 ようこそ！まずはアイテムを追加してみましょう', 'info'); }, 1000);
    }
});
window.addEventListener('beforeunload', () => { if (isScanning) stopScanning(); if (isCheckScanning) stopCheckScanning(); });

</script>
</body>
</html>
