<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ“š å¿˜ã‚Œç‰©é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ  Pro</title>
<meta name="theme-color" content="#007bff">

<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #f8f9fa; padding: 0.5em; line-height: 1.6;
  }
  .container { max-width: 480px; margin: 0 auto; }
  header {
    background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 1em;
    border-radius: 12px; text-align: center; margin-bottom: 1em;
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
  }
  .tab-nav {
    display: flex; background: white; border-radius: 8px;
    margin-bottom: 1em; overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .tab-btn {
    flex: 1; padding: 0.8em; border: none; background: white;
    cursor: pointer; font-weight: 500; transition: all 0.2s;
    font-size: 13px;
  }
  .tab-btn.active { background: #007bff; color: white; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .card {
    background: white; border-radius: 12px; padding: 1.2em;
    margin-bottom: 1em; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  /* ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ */
  #viewport, #check-viewport {
    position: relative; width: 100%; height: 250px;
    border: 2px solid #007bff; border-radius: 12px;
    overflow: hidden; background: #000; margin-bottom: 1em;
  }
  video { width: 100%; height: 100%; object-fit: cover; }
  .guide {
    position: absolute; top: 20%; left: 15%; right: 15%; bottom: 20%;
    border: 3px dashed #00ff00; background: rgba(0,255,0,0.1);
    pointer-events: none; border-radius: 8px;
  }
  
  /* ãƒœã‚¿ãƒ³ */
  .btn {
    padding: 0.8em 1.5em; border: none; border-radius: 8px;
    font-weight: 600; cursor: pointer; transition: all 0.2s;
    margin: 0.3em; display: inline-block; text-decoration: none;
    text-align: center; font-size: 14px;
  }
  .btn-primary { background: #007bff; color: white; }
  .btn-secondary { background: #6c757d; color: white; }
  .btn-success { background: #28a745; color: white; }
  .btn-danger { background: #dc3545; color: white; }
  .btn-warning { background: #ffc107; color: #333; }
  .btn-info { background: #17a2b8; color: white; }
  .btn:disabled { background: #ccc; cursor: not-allowed; }
  .btn-sm { padding: 0.4em 0.8em; font-size: 12px; margin: 0.2em; }
  
  /* ãƒ•ã‚©ãƒ¼ãƒ  */
  .input-group { margin-bottom: 1em; }
  .input-group label { display: block; margin-bottom: 0.3em; font-weight: 500; }
  .input-group input, .input-group select, .input-group textarea {
    width: 100%; padding: 0.7em; border: 2px solid #ddd;
    border-radius: 8px; font-size: 14px;
  }
  .input-group input:focus, .input-group select:focus {
    outline: none; border-color: #007bff;
  }
  .input-row { display: flex; gap: 0.5em; }
  .input-row .input-group { flex: 1; }
  
  /* ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ */
  .item-list { list-style: none; padding-left: 0; }
  .item {
    display: flex; align-items: center; padding: 0.8em;
    border: 2px solid #e9ecef; border-radius: 8px;
    margin-bottom: 0.5em; transition: all 0.2s; position: relative;
  }
  .item.checked {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    border-color: #28a745;
  }
  .item.scanned {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-color: #2196f3;
    animation: pulse 0.6s ease-in-out;
  }
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
  }
  .item-checkbox { margin-right: 0.8em; transform: scale(1.2); }
  .item-info { flex: 1; }
  .item-name { font-weight: 600; color: #333; }
  .item-details { font-size: 0.8em; color: #666; margin-top: 0.2em; }
  .item-code { color: #007bff; }
  .item-category { color: #6c757d; font-weight: 500; }
  .item-days { color: #28a745; }
  .item-actions { display: flex; gap: 0.3em; }
  
  /* ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¿ãƒ– */
  .category-tabs {
    display: flex; gap: 0.3em; margin-bottom: 1em; flex-wrap: wrap;
  }
  .category-btn {
    padding: 0.5em 1em; border: 2px solid #007bff; background: white;
    color: #007bff; border-radius: 20px; cursor: pointer;
    font-weight: 500; transition: all 0.2s; font-size: 13px;
  }
  .category-btn.active { background: #007bff; color: white; }
  
  /* æ¤œç´¢ãƒãƒ¼ */
  .search-bar {
    position: relative; margin-bottom: 1em;
  }
  .search-input {
    width: 100%; padding: 0.7em 2.5em 0.7em 0.7em;
    border: 2px solid #ddd; border-radius: 8px;
  }
  .search-clear {
    position: absolute; right: 0.5em; top: 50%;
    transform: translateY(-50%); background: none; border: none;
    cursor: pointer; font-size: 16px; color: #666;
  }
  
  /* ãƒ—ãƒªã‚»ãƒƒãƒˆ */
  .preset-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 0.5em; margin-bottom: 1em;
  }
  .preset-btn {
    padding: 0.6em; border: 2px solid #007bff; background: white;
    color: #007bff; border-radius: 8px; cursor: pointer;
    font-weight: 500; transition: all 0.2s; text-align: center;
  }
  .preset-btn.active { background: #007bff; color: white; }
  
  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
  #status, #check-status {
    padding: 0.8em; border-radius: 8px; margin-bottom: 1em;
    text-align: center; font-weight: 500;
    background: #e3f2fd; color: #1976d2; border: 2px solid #bbdefb;
  }
  .status-success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
  .status-warning { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
  .status-error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
  
  /* çµ±è¨ˆ */
  .stats {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 0.8em; margin-bottom: 1em;
  }
  .stat-card {
    text-align: center; padding: 0.8em; background: white;
    border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .stat-number { font-size: 1.5em; font-weight: 700; color: #007bff; }
  .stat-label { font-size: 0.8em; color: #666; margin-top: 0.2em; }
  
  /* ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ */
  .scan-mode {
    display: flex; background: #f8f9fa; border-radius: 8px;
    margin-bottom: 1em; overflow: hidden; border: 2px solid #dee2e6;
  }
  .scan-mode-btn {
    flex: 1; padding: 0.6em; border: none; background: transparent;
    cursor: pointer; font-weight: 500; transition: all 0.2s;
  }
  .scan-mode-btn.active { background: #007bff; color: white; }
  
  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
  }
  .modal.active { display: flex; }
  .modal-content {
    background: white; border-radius: 12px; padding: 1.5em;
    max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto;
  }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
  .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }
  
  /* ãƒã‚§ãƒƒã‚¯çµæœè¡¨ç¤º */
  .check-result {
    padding: 1em; border-radius: 8px; margin-bottom: 1em;
    text-align: center; font-weight: 600; display: none;
  }
  .check-result.found {
    background: #d4edda; color: #155724; border: 2px solid #c3e6cb;
    display: block;
  }
  .check-result.not-found {
    background: #fff3cd; color: #856404; border: 2px solid #ffeaa7;
    display: block;
  }
  
  /* å…±é€šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè¡¨ç¤º */
  .shared-checklist {
    margin-top: 1em;
  }
  
  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
  @media (max-width: 480px) {
    body { padding: 0.3em; }
    .tab-btn { padding: 0.6em 0.4em; font-size: 12px; }
    .btn { padding: 0.6em 1.2em; font-size: 13px; }
    .input-row { flex-direction: column; }
    .stats { grid-template-columns: repeat(2, 1fr); }
  }
</style>

</head>
<body>
<div class="container">
<header>
<h1>ğŸ“š å¿˜ã‚Œç‰©é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ  Pro</h1>
<p>æ•™æãƒ»æŒã¡ç‰©ã‚’ã¾ã¨ã‚ã¦ç®¡ç†ï¼</p>
</header>

<nav class="tab-nav">
<button class="tab-btn active" data-tab="quick">âš¡ ã‚¯ã‚¤ãƒƒã‚¯</button>
<button class="tab-btn" data-tab="scanner">ğŸ“± ç™»éŒ²</button>
<button class="tab-btn" data-tab="items">ğŸ“‹ ä¸€è¦§</button>
<button class="tab-btn" data-tab="check">âœ… ãƒã‚§ãƒƒã‚¯</button>
<button class="tab-btn" data-tab="settings">âš™ï¸ è¨­å®š</button>
</nav>

<!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¿ãƒ– -->
<div id="quick" class="tab-content active">
<div class="stats">
<div class="stat-card">
<div class="stat-number" id="total-items">0</div>
<div class="stat-label">ç·ã‚¢ã‚¤ãƒ†ãƒ </div>
</div>
<div class="stat-card">
<div class="stat-number" id="checked-items">0</div>
<div class="stat-label">ãƒã‚§ãƒƒã‚¯æ¸ˆ</div>
</div>
<div class="stat-card">
<div class="stat-number" id="today-items">0</div>
<div class="stat-label">ä»Šæ—¥ã®äºˆå®š</div>
</div>
</div>

<div class="card">
<h3>ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯è¿½åŠ </h3>
<div class="input-row">
<div class="input-group">
<input type="text" id="quick-name" placeholder="ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥åŠ›" style="font-size: 16px;">
</div>
<button id="quick-add" class="btn btn-success" style="white-space: nowrap;">â• è¿½åŠ </button>
</div>
<div style="margin-top: 0.5em;">
<select id="quick-category" style="margin-right: 0.5em; padding: 0.5em;">
<option value="æ•™æ">ğŸ“š æ•™æ</option>
<option value="æ–‡æˆ¿å…·">âœï¸ æ–‡æˆ¿å…·</option>
<option value="ä½“è‚²ç”¨å“">âš½ ä½“è‚²ç”¨å“</option>
<option value="å¼å½“ãƒ»æ°´ç­’">ğŸ± å¼å½“ãƒ»æ°´ç­’</option>
<option value="ãã®ä»–">ğŸ“¦ ãã®ä»–</option>
</select>
<button id="quick-scan" class="btn btn-info btn-sm">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³è¿½åŠ </button>
</div>
</div>

<div class="card">
<h3>ğŸ“… ä»Šæ—¥ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
<ul id="today-checklist" class="item-list"></ul>
</div>
</div>

<!-- ã‚¹ã‚­ãƒ£ãƒ³ã‚¿ãƒ–ï¼ˆç™»éŒ²ç”¨ï¼‰ -->
<div id="scanner" class="tab-content">
<div class="card">
<div id="viewport"><div class="guide"></div></div>
<div id="status">ğŸ“· æº–å‚™å®Œäº† - ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
<div style="text-align: center;">
<button id="scan-btn" class="btn btn-primary">ğŸš€ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
<button id="stop-btn" class="btn btn-secondary" disabled>â¹ åœæ­¢</button>
</div>
</div>

<div class="card">
<h3>ğŸ“– è©³ç´°ç™»éŒ²</h3>
<div class="input-group">
<label>ã‚¢ã‚¤ãƒ†ãƒ å *</label>
<input type="text" id="detail-name" placeholder="ä¾‹: æ•°å­¦ã®æ•™ç§‘æ›¸">
</div>
<div class="input-row">
<div class="input-group">
<label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
<select id="detail-category">
<option value="æ•™æ">ğŸ“š æ•™æ</option>
<option value="æ–‡æˆ¿å…·">âœï¸ æ–‡æˆ¿å…·</option>
<option value="ä½“è‚²ç”¨å“">âš½ ä½“è‚²ç”¨å“</option>
<option value="å¼å½“ãƒ»æ°´ç­’">ğŸ± å¼å½“ãƒ»æ°´ç­’</option>
<option value="åˆ¶æœãƒ»æœè£…">ğŸ‘” åˆ¶æœãƒ»æœè£…</option>
<option value="æ¥½å™¨">ğŸµ æ¥½å™¨</option>
<option value="éƒ¨æ´»ç”¨å“">ğŸƒ éƒ¨æ´»ç”¨å“</option>
<option value="ãã®ä»–">ğŸ“¦ ãã®ä»–</option>
</select>
</div>
<div class="input-group">
<label>é‡è¦åº¦</label>
<select id="detail-priority">
<option value="æ™®é€š">æ™®é€š</option>
<option value="é‡è¦">â­ é‡è¦</option>
<option value="å¿…é ˆ">â€¼ï¸ å¿…é ˆ</option>
</select>
</div>
</div>
<div class="input-group">
<label>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ (ä»»æ„)</label>
<input type="text" id="detail-code" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã¾ãŸã¯ç‹¬è‡ªID">
</div>
<div class="input-group">
<label>ãƒ¡ãƒ¢ (ä»»æ„)</label>
<textarea id="detail-memo" rows="2" placeholder="è¿½åŠ æƒ…å ±ã‚„ãƒ¡ãƒ¢"></textarea>
</div>
<div class="input-group">
<label>å¿…è¦ãªæ›œæ—¥</label>
<div style="display: flex; flex-wrap: wrap; gap: 0.3em;">
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="æœˆ" style="margin-right: 0.3em;"> æœˆ</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="ç«" style="margin-right: 0.3em;"> ç«</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="æ°´" style="margin-right: 0.3em;"> æ°´</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="æœ¨" style="margin-right: 0.3em;"> æœ¨</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="é‡‘" style="margin-right: 0.3em;"> é‡‘</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="åœŸ" style="margin-right: 0.3em;"> åœŸ</label>
<label style="display: flex; align-items: center;"><input type="checkbox" value="æ—¥" style="margin-right: 0.3em;"> æ—¥</label>
</div>
</div>
<button id="add-detail" class="btn btn-success" style="width: 100%;">â• è©³ç´°ç™»éŒ²</button>
</div>
</div>

<!-- ä¸€è¦§ã‚¿ãƒ– -->
<div id="items" class="tab-content">
<div class="card">
<div class="search-bar">
<input type="text" id="search-input" class="search-input" placeholder="ğŸ” ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œç´¢...">
<button id="search-clear" class="search-clear">Ã—</button>
</div>
<div class="category-tabs" id="category-tabs">
<button class="category-btn active" data-category="all">å…¨ã¦</button>
<button class="category-btn" data-category="æ•™æ">ğŸ“š æ•™æ</button>
<button class="category-btn" data-category="æ–‡æˆ¿å…·">âœï¸ æ–‡æˆ¿å…·</button>
<button class="category-btn" data-category="ä½“è‚²ç”¨å“">âš½ ä½“è‚²</button>
<button class="category-btn" data-category="å¼å½“ãƒ»æ°´ç­’">ğŸ± å¼å½“</button>
<button class="category-btn" data-category="ãã®ä»–">ğŸ“¦ ä»–</button>
</div>
</div>

<div class="card">
<h3 id="items-title">ğŸ“š å…¨ã‚¢ã‚¤ãƒ†ãƒ  (0ä»¶)</h3>
<ul id="items-list" class="item-list"></ul>
<div style="text-align: center; margin-top: 1em;">
<button id="sort-toggle" class="btn btn-secondary btn-sm">ğŸ“Š ä¸¦ã³æ›¿ãˆ</button>
<button id="clear-items" class="btn btn-danger btn-sm">ğŸ—‘ å…¨å‰Šé™¤</button>
</div>
</div>
</div>

<!-- ãƒã‚§ãƒƒã‚¯ã‚¿ãƒ– -->
<div id="check" class="tab-content">
<div class="card">
<h3>âœ… æ›œæ—¥åˆ¥ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
<div class="preset-grid" id="preset-days">
<button class="preset-btn" data-day="æœˆ">æœˆ</button>
<button class="preset-btn" data-day="ç«">ç«</button>
<button class="preset-btn" data-day="æ°´">æ°´</button>
<button class="preset-btn" data-day="æœ¨">æœ¨</button>
<button class="preset-btn" data-day="é‡‘">é‡‘</button>
<button class="preset-btn" data-day="åœŸ">åœŸ</button>
<button class="preset-btn" data-day="æ—¥">æ—¥</button>
</div>
</div>

<div class="card">
<h3>ğŸ“· ãƒã‚§ãƒƒã‚¯æ–¹æ³•é¸æŠ</h3>
<div class="scan-mode">
<button class="scan-mode-btn active" data-mode="manual">âœ‹ æ‰‹å‹•ãƒã‚§ãƒƒã‚¯</button>
<button class="scan-mode-btn" data-mode="scan">ğŸ“± ã‚¹ã‚­ãƒ£ãƒ³ãƒã‚§ãƒƒã‚¯</button>
</div>

<!-- æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ -->
<div id="manual-check-mode">
<div id="check-progress" style="text-align: center; margin: 1em 0; font-weight: 600;"></div>
<ul id="checklist" class="item-list"></ul>
<div style="text-align: center; margin-top: 1em;">
<button id="check-all" class="btn btn-success btn-sm">âœ… å…¨é¸æŠ</button>
<button id="uncheck-all" class="btn btn-warning btn-sm">â­• å…¨è§£é™¤</button>
<button id="reset-check" class="btn btn-secondary btn-sm">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
</div>
</div>

<!-- ã‚¹ã‚­ãƒ£ãƒ³ãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ -->
<div id="scan-check-mode" style="display: none;">
<div id="check-viewport"><div class="guide"></div></div>
<div id="check-status">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦è‡ªå‹•ãƒã‚§ãƒƒã‚¯</div>
<div style="text-align: center;">
<button id="check-scan-btn" class="btn btn-primary">ğŸš€ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
<button id="check-stop-btn" class="btn btn-secondary" disabled>â¹ åœæ­¢</button>
</div>
<div id="check-result" class="check-result"></div>

<!-- ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚å…±é€šã®ãƒã‚§ãƒƒã‚¯çŠ¶æ³è¡¨ç¤º -->
<div class="shared-checklist">
<div id="scan-check-progress" style="text-align: center; margin: 1em 0; font-weight: 600;"></div>
<ul id="scan-checklist" class="item-list"></ul>
<div style="text-align: center; margin-top: 1em;">
<button id="scan-check-all" class="btn btn-success btn-sm">âœ… å…¨é¸æŠ</button>
<button id="scan-uncheck-all" class="btn btn-warning btn-sm">â­• å…¨è§£é™¤</button>
<button id="scan-reset-check" class="btn btn-secondary btn-sm">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
</div>
</div>

<div style="margin-top: 2em;">
<h4>ğŸ“Š ã‚¹ã‚­ãƒ£ãƒ³çµæœ</h4>
<ul id="scan-results" class="item-list"></ul>
</div>
</div>
</div>
</div>

<!-- è¨­å®šã‚¿ãƒ– -->
<div id="settings" class="tab-content">
<div class="card">
<h3>ğŸ“Š çµ±è¨ˆæƒ…å ±</h3>
<div class="stats" id="detailed-stats">
<div class="stat-card">
<div class="stat-number" id="stat-total">0</div>
<div class="stat-label">ç·ã‚¢ã‚¤ãƒ†ãƒ æ•°</div>
</div>
<div class="stat-card">
<div class="stat-number" id="stat-categories">0</div>
<div class="stat-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼æ•°</div>
</div>
<div class="stat-card">
<div class="stat-number" id="stat-barcodes">0</div>
<div class="stat-label">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ä»˜ã</div>
</div>
<div class="stat-card">
<div class="stat-number" id="stat-completion">0%</div>
<div class="stat-label">å®Œäº†ç‡</div>
</div>
</div>
</div>

<div class="card">
<h3>âš™ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin-bottom: 1em;">
<button id="export-btn" class="btn btn-primary">â¬‡ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
<label for="import-file" class="btn btn-secondary" style="margin:0; text-align:center; display:flex; align-items:center; justify-content:center;">â¬† ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</label>
</div>
<input type="file" id="import-file" style="display:none;" accept="application/json">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em;">
<button id="backup-btn" class="btn btn-info">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
<button id="restore-btn" class="btn btn-warning">ğŸ”„ å¾©å…ƒ</button>
</div>
<div id="status-msg" style="margin-top:1em; text-align:center; font-weight:600;"></div>
</div>

<div class="card">
<h3>ğŸ“± PWAæƒ…å ±</h3>
<p>ã“ã®ã‚¢ãƒ—ãƒªã¯PWAå¯¾å¿œã§ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ï¼š</p>
<ul style="margin:0.5em 0 1em 1.5em;">
<li>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œ</li>
<li>ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ </li>
<li>ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šä¿å­˜</li>
<li>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯</li>
</ul>
<button id="install-pwa" class="btn btn-success" style="display:none;">ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </button>
</div>
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="edit-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3>âœï¸ ã‚¢ã‚¤ãƒ†ãƒ ç·¨é›†</h3>
<button class="modal-close" onclick="closeEditModal()">Ã—</button>
</div>
<div class="input-group">
<label>ã‚¢ã‚¤ãƒ†ãƒ å</label>
<input type="text" id="edit-name">
</div>
<div class="input-row">
<div class="input-group">
<label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
<select id="edit-category">
<option value="æ•™æ">ğŸ“š æ•™æ</option>
<option value="æ–‡æˆ¿å…·">âœï¸ æ–‡æˆ¿å…·</option>
<option value="ä½“è‚²ç”¨å“">âš½ ä½“è‚²ç”¨å“</option>
<option value="å¼å½“ãƒ»æ°´ç­’">ğŸ± å¼å½“ãƒ»æ°´ç­’</option>
<option value="åˆ¶æœãƒ»æœè£…">ğŸ‘” åˆ¶æœãƒ»æœè£…</option>
<option value="æ¥½å™¨">ğŸµ æ¥½å™¨</option>
<option value="éƒ¨æ´»ç”¨å“">ğŸƒ éƒ¨æ´»ç”¨å“</option>
<option value="ãã®ä»–">ğŸ“¦ ãã®ä»–</option>
</select>
</div>
<div class="input-group">
<label>é‡è¦åº¦</label>
<select id="edit-priority">
<option value="æ™®é€š">æ™®é€š</option>
<option value="é‡è¦">â­ é‡è¦</option>
<option value="å¿…é ˆ">â€¼ï¸ å¿…é ˆ</option>
</select>
</div>
</div>
<div class="input-group">
<label>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</label>
<input type="text" id="edit-code">
</div>
<div class="input-group">
<label>ãƒ¡ãƒ¢</label>
<textarea id="edit-memo" rows="2"></textarea>
</div>
<div class="input-group">
<label>å¿…è¦ãªæ›œæ—¥</label>
<div id="edit-days" style="display: flex; flex-wrap: wrap; gap: 0.3em;">
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="æœˆ" style="margin-right: 0.3em;"> æœˆ</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="ç«" style="margin-right: 0.3em;"> ç«</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="æ°´" style="margin-right: 0.3em;"> æ°´</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="æœ¨" style="margin-right: 0.3em;"> æœ¨</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="é‡‘" style="margin-right: 0.3em;"> é‡‘</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="åœŸ" style="margin-right: 0.3em;"> åœŸ</label>
<label style="display: flex; align-items: center;"><input type="checkbox" value="æ—¥" style="margin-right: 0.3em;"> æ—¥</label>
</div>
</div>
<div style="display: flex; gap: 0.5em; margin-top: 1em;">
<button id="save-edit" class="btn btn-success" style="flex: 1;">ğŸ’¾ ä¿å­˜</button>
<button onclick="closeEditModal()" class="btn btn-secondary">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>
</div>
</div>

</div>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
// PWAè¨­å®š
const manifestData = {
  "name": "å¿˜ã‚Œç‰©é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ  Pro",
  "short_name": "å¿˜ã‚Œç‰©Pro",
  "description": "æ•™æãƒ»æŒã¡ç‰©ã‚’çµ±åˆç®¡ç†ã™ã‚‹å¿˜ã‚Œç‰©é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ ",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#007bff",
  "orientation": "portrait",
  "icons": [
    { "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==", "sizes": "192x192", "type": "image/png" },
    { "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==", "sizes": "512x512", "type": "image/png" }
  ]
};

const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(manifestBlob);
const link = document.createElement('link');
link.rel = 'manifest';
link.href = manifestURL;
document.head.appendChild(link);

// Service Workerç™»éŒ²
const swCode = `
const CACHE_NAME = 'wasuremono-pro-v2.1';
const urlsToCache = ['./', 'https://unpkg.com/quagga@0.12.1/dist/quagga.min.js'];
self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(urlsToCache).catch(() => c.add('./')))));
self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).catch(() => caches.match('./')))));
`;

if ('serviceWorker' in navigator) {
  const swBlob = new Blob([swCode], {type: 'application/javascript'});
  const swURL = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swURL).then(() => console.log('SW registered')).catch(console.error);
}

// IndexedDBè¨­å®š
const DB_NAME = 'wasuremonoPro';
const DB_VERSION = 2;
const STORE_NAME = 'items';
let db;

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onerror = () => reject(request.error);
    request.onsuccess = () => { db = request.result; resolve(db); };
    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        store.createIndex('category', 'category', { unique: false });
        store.createIndex('name', 'name', { unique: false });
        store.createIndex('code', 'code', { unique: false });
      }
    };
  });
}

// CRUDæ“ä½œ
function addItem(item) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const request = store.add(item);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function getAllItems() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function updateItem(item) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const request = store.put(item);
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

function deleteItem(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const request = store.delete(id);
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

function clearItems() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const request = store.clear();
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let items = [];
let currentDay = null;
let currentCategory = 'all';
let sortBy = 'name';
let isScanning = false;
let isCheckScanning = false;
let editingItem = null;
let checkMode = 'manual';
let scanResults = new Map();

// UIè¦ç´ 
const tabs = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
const status = document.getElementById('status');
const checkStatus = document.getElementById('check-status');

// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    const target = tab.dataset.tab;
    tabContents.forEach(tc => {
      tc.classList.toggle('active', tc.id === target);
    });
    
    if (target === 'quick') {
      updateStats();
      renderTodayChecklist();
    } else if (target === 'items') {
      renderItems();
    } else if (target === 'check') {
      if (!currentDay) selectCurrentDay();
      updateCheckDisplay();
    } else if (target === 'settings') {
      updateDetailedStats();
    }
  });
});

// ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
document.querySelectorAll('.scan-mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.scan-mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    checkMode = btn.dataset.mode;
    
    if (checkMode === 'manual') {
      document.getElementById('manual-check-mode').style.display = 'block';
      document.getElementById('scan-check-mode').style.display = 'none';
      if (isCheckScanning) stopCheckScanning();
    } else {
      document.getElementById('manual-check-mode').style.display = 'none';
      document.getElementById('scan-check-mode').style.display = 'block';
      updateCheckDisplay(); // ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ãƒã‚§ãƒƒã‚¯çŠ¶æ³è¡¨ç¤º
    }
  });
});

// çµ±è¨ˆæ›´æ–°
function updateStats() {
  const total = items.length;
  const checked = items.filter(i => i.checked).length;
  const today = getTodayItems().length;
  
  document.getElementById('total-items').textContent = total;
  document.getElementById('checked-items').textContent = checked;
  document.getElementById('today-items').textContent = today;
}

function updateDetailedStats() {
  const total = items.length;
  const categories = [...new Set(items.map(i => i.category))].length;
  const barcodes = items.filter(i => i.code).length;
  const checked = items.filter(i => i.checked).length;
  const completion = total > 0 ? Math.round((checked / total) * 100) : 0;
  
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-categories').textContent = categories;
  document.getElementById('stat-barcodes').textContent = barcodes;
  document.getElementById('stat-completion').textContent = completion + '%';
}

// ä»Šæ—¥ã®ã‚¢ã‚¤ãƒ†ãƒ å–å¾—
function getTodayItems() {
  const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
  const today = days[new Date().getDay()];
  return items.filter(i => i.days.includes(today));
}

// ä»Šæ—¥ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè¡¨ç¤º
function renderTodayChecklist() {
  const todayItems = getTodayItems();
  const list = document.getElementById('today-checklist');
  
  if (todayItems.length === 0) {
    list.innerHTML = '<li style="text-align:center; color:#999; padding:2em;">ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</li>';
    return;
  }
  
  list.innerHTML = '';
  todayItems.forEach(item => {
    const li = createItemElement(item, true);
    list.appendChild(li);
  });
}

// ã‚¢ã‚¤ãƒ†ãƒ è¦ç´ ä½œæˆ
function createItemElement(item, isQuick = false) {
  const li = document.createElement('li');
  li.className = 'item' + (item.checked ? ' checked' : '');
  li.dataset.id = item.id;

  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.className = 'item-checkbox';
  checkbox.checked = !!item.checked;
  checkbox.addEventListener('change', async () => {
    item.checked = checkbox.checked;
    await updateItem(item);
    updateStats();
    updateCheckDisplay();
    if (!isQuick) renderItems();
    if (isQuick) renderTodayChecklist();
    
    if (checkbox.checked && navigator.vibrate) {
      navigator.vibrate([100, 50, 100]);
    }
  });

  const info = document.createElement('div');
  info.className = 'item-info';
  
  let priorityIcon = '';
  if (item.priority === 'é‡è¦') priorityIcon = 'â­ ';
  else if (item.priority === 'å¿…é ˆ') priorityIcon = 'â€¼ï¸ ';
  
  let categoryIcon = getCategoryIcon(item.category);
  
  info.innerHTML = `
    <div class="item-name">${priorityIcon}${item.name}</div>
    <div class="item-details">
      <span class="item-category">${categoryIcon} ${item.category}</span>
      ${item.code ? `<span class="item-code"> â€¢ ${item.code}</span>` : ''}
      ${item.days.length > 0 ? `<span class="item-days"> â€¢ ${item.days.join(', ')}</span>` : ''}
      ${item.memo ? `<br><small style="color:#666;">${item.memo}</small>` : ''}
    </div>
  `;

  if (!isQuick) {
    const actions = document.createElement('div');
    actions.className = 'item-actions';
    
    const editBtn = document.createElement('button');
    editBtn.textContent = 'âœï¸';
    editBtn.className = 'btn btn-info btn-sm';
    editBtn.addEventListener('click', () => openEditModal(item));
    
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'ğŸ—‘';
    deleteBtn.className = 'btn btn-danger btn-sm';
    deleteBtn.addEventListener('click', async () => {
      if (confirm(`ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        await deleteItem(item.id);
        items = items.filter(i => i.id !== item.id);
        renderItems();
        updateStats();
        updateCheckDisplay();
        showStatus('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
      }
    });
    
    actions.appendChild(editBtn);
    actions.appendChild(deleteBtn);
    li.appendChild(actions);
  }

  li.appendChild(checkbox);
  li.appendChild(info);
  
  return li;
}

// ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¢ã‚¤ã‚³ãƒ³å–å¾—
function getCategoryIcon(category) {
  const icons = {
    'æ•™æ': 'ğŸ“š', 'æ–‡æˆ¿å…·': 'âœï¸', 'ä½“è‚²ç”¨å“': 'âš½', 'å¼å½“ãƒ»æ°´ç­’': 'ğŸ±',
    'åˆ¶æœãƒ»æœè£…': 'ğŸ‘”', 'æ¥½å™¨': 'ğŸµ', 'éƒ¨æ´»ç”¨å“': 'ğŸƒ', 'ãã®ä»–': 'ğŸ“¦'
  };
  return icons[category] || 'ğŸ“¦';
}

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
function showStatus(message, type = 'info') {
  const statusEl = document.getElementById('status-msg') || status;
  statusEl.textContent = message;
  statusEl.className = statusEl.className.replace(/status-\w+/g, '') + ` status-${type}`;
  setTimeout(() => {
    statusEl.textContent = '';
    statusEl.className = statusEl.className.replace(/status-\w+/g, '');
  }, 3000);
}

// ãƒã‚§ãƒƒã‚¯çŠ¶æ³è¡¨ç¤ºã®çµ±ä¸€åŒ–
function updateCheckDisplay() {
  if (!currentDay) return;
  
  // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã¨ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰ä¸¡æ–¹ã‚’æ›´æ–°
  renderChecklist(currentDay);
  renderScanChecklist(currentDay);
}

// æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè¡¨ç¤º
function renderChecklist(day) {
  const list = document.getElementById('checklist');
  const progress = document.getElementById('check-progress');
  
  const filtered = items.filter(i => i.days.includes(day));
  
  if (filtered.length === 0) {
    list.innerHTML = '<li style="text-align:center; color:#999; padding:2em;">' + day + 'æ›œæ—¥ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</li>';
    progress.innerHTML = '';
    return;
  }
  
  const checkedCount = filtered.filter(i => i.checked).length;
  const totalCount = filtered.length;
  const percentage = Math.round((checkedCount / totalCount) * 100);
  
  progress.innerHTML = `
    <div style="color: ${checkedCount === totalCount ? '#28a745' : '#007bff'};">
      ${day}æ›œæ—¥: ${checkedCount}/${totalCount} å®Œäº† (${percentage}%) ${checkedCount === totalCount ? 'ğŸ‰' : ''}
    </div>
  `;
  
  list.innerHTML = '';
  
  filtered.sort((a, b) => {
    const priorities = { 'å¿…é ˆ': 3, 'é‡è¦': 2, 'æ™®é€š': 1 };
    return priorities[b.priority] - priorities[a.priority];
  });
  
  filtered.forEach(item => {
    const li = createItemElement(item, true);
    li.style.border = item.priority === 'å¿…é ˆ' ? '2px solid #dc3545' : 
                     item.priority === 'é‡è¦' ? '2px solid #ffc107' : '2px solid #e9ecef';
    list.appendChild(li);
  });
}

// ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè¡¨ç¤º
function renderScanChecklist(day) {
  const list = document.getElementById('scan-checklist');
  const progress = document.getElementById('scan-check-progress');
  
  const filtered = items.filter(i => i.days.includes(day));
  
  if (filtered.length === 0) {
    list.innerHTML = '<li style="text-align:center; color:#999; padding:2em;">' + day + 'æ›œæ—¥ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</li>';
    progress.innerHTML = '';
    return;
  }
  
  const checkedCount = filtered.filter(i => i.checked).length;
  const totalCount = filtered.length;
  const percentage = Math.round((checkedCount / totalCount) * 100);
  
  progress.innerHTML = `
    <div style="color: ${checkedCount === totalCount ? '#28a745' : '#007bff'};">
      ${day}æ›œæ—¥: ${checkedCount}/${totalCount} å®Œäº† (${percentage}%) ${checkedCount === totalCount ? 'ğŸ‰' : ''}
    </div>
  `;
  
  list.innerHTML = '';
  
  filtered.sort((a, b) => {
    const priorities = { 'å¿…é ˆ': 3, 'é‡è¦': 2, 'æ™®é€š': 1 };
    return priorities[b.priority] - priorities[a.priority];
  });
  
  filtered.forEach(item => {
    const li = createItemElement(item, true);
    li.style.border = item.priority === 'å¿…é ˆ' ? '2px solid #dc3545' : 
                     item.priority === 'é‡è¦' ? '2px solid #ffc107' : '2px solid #e9ecef';
    list.appendChild(li);
  });
}

// ã‚¯ã‚¤ãƒƒã‚¯è¿½åŠ 
document.getElementById('quick-add').addEventListener('click', async () => {
  const name = document.getElementById('quick-name').value.trim();
  const category = document.getElementById('quick-category').value;
  
  if (!name) {
    document.getElementById('quick-name').focus();
    return;
  }
  
  const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
  const today = days[new Date().getDay()];
  
  const success = await addNewItem({
    name, category, priority: 'æ™®é€š', days: [today], code: '', memo: ''
  });
  
  if (success) {
    document.getElementById('quick-name').value = '';
    renderTodayChecklist();
    updateStats();
    showStatus(`âœ… ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
  }
});

document.getElementById('quick-name').addEventListener('keypress', e => {
  if (e.key === 'Enter') document.getElementById('quick-add').click();
});

// ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚­ãƒ£ãƒ³
document.getElementById('quick-scan').addEventListener('click', () => {
  document.querySelector('[data-tab="scanner"]').click();
  setTimeout(() => {
    if (!isScanning) document.getElementById('scan-btn').click();
  }, 500);
});

// ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ ï¼ˆå…±é€šé–¢æ•°ï¼‰
async function addNewItem(itemData) {
  if (!itemData.name.trim()) return false;
  
  if (itemData.code && items.some(i => i.code === itemData.code)) {
    showStatus('åŒã˜ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™', 'warning');
    return false;
  }
  
  const item = {
    name: itemData.name.trim(),
    category: itemData.category || 'ãã®ä»–',
    priority: itemData.priority || 'æ™®é€š',
    code: itemData.code ? itemData.code.trim() : '',
    memo: itemData.memo ? itemData.memo.trim() : '',
    days: itemData.days || [],
    checked: false,
    createdAt: new Date().toISOString()
  };
  
  try {
    item.id = await addItem(item);
    items.push(item);
    return true;
  } catch (err) {
    showStatus('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
    return false;
  }
}

// è©³ç´°ç™»éŒ²
document.getElementById('add-detail').addEventListener('click', async () => {
  const name = document.getElementById('detail-name').value;
  const category = document.getElementById('detail-category').value;
  const priority = document.getElementById('detail-priority').value;
  const code = document.getElementById('detail-code').value;
  const memo = document.getElementById('detail-memo').value;
  const dayCheckboxes = document.querySelectorAll('#scanner input[type=checkbox]:checked');
  const days = Array.from(dayCheckboxes).map(cb => cb.value);
  
  if (!name.trim()) {
    document.getElementById('detail-name').focus();
    showStatus('ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
    return;
  }
  
  const success = await addNewItem({ name, category, priority, code, memo, days });
  if (success) {
    document.getElementById('detail-name').value = '';
    document.getElementById('detail-code').value = '';
    document.getElementById('detail-memo').value = '';
    dayCheckboxes.forEach(cb => cb.checked = false);
    
    updateStats();
    renderItems();
    updateCheckDisplay();
    showStatus(`âœ… ã€Œ${name}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`, 'success');
  }
});

// ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼è¨­å®š
const scanBtn = document.getElementById('scan-btn');
const stopBtn = document.getElementById('stop-btn');
const viewport = document.getElementById('viewport');

const checkScanBtn = document.getElementById('check-scan-btn');
const checkStopBtn = document.getElementById('check-stop-btn');
const checkViewport = document.getElementById('check-viewport');

const quaggaConfig = {
  inputStream: {
    name: 'Live', type: 'LiveStream',
    constraints: {
      facingMode: 'environment',
      width: { min: 640, ideal: 800, max: 1280 },
      height: { min: 480, ideal: 600, max: 720 }
    },
    area: { top: '20%', right: '15%', left: '15%', bottom: '20%' },
    willReadFrequently: true
  },
  frequency: 8, numOfWorkers: 2,
  decoder: { readers: ['ean_reader', 'ean_8_reader', 'code_128_reader'], multiple: false },
  locate: true,
  locator: { patchSize: 'medium', halfSample: false },
  debug: { drawBoundingBox: true, showFrequency: false, drawScanline: true, showPattern: false }
};

// ç™»éŒ²ç”¨ã‚¹ã‚­ãƒ£ãƒ³æ¤œå‡º
function onDetected(result) {
  const code = result.codeResult.code;
  if (!code) return;
  
  const existing = items.find(i => i.code === code);
  if (existing) {
    status.textContent = `âœ… æ—¢ã«ç™»éŒ²æ¸ˆã¿: ${existing.name} (${code})`;
    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    return;
  }
  
  status.textContent = `ğŸ“– æ¤œå‡º: ${code} - ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
  document.getElementById('detail-code').value = code;
  document.getElementById('detail-name').focus();
  
  if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
}

// ãƒã‚§ãƒƒã‚¯ç”¨ã‚¹ã‚­ãƒ£ãƒ³æ¤œå‡º
function onCheckDetected(result) {
  const code = result.codeResult.code;
  if (!code) return;
  
  const dayItems = items.filter(i => i.days.includes(currentDay));
  const foundItem = dayItems.find(i => i.code === code);
  
  if (foundItem) {
    if (!foundItem.checked) {
      foundItem.checked = true;
      updateItem(foundItem);
      updateStats();
      updateCheckDisplay();
      
      scanResults.set(code, {
        item: foundItem,
        timestamp: new Date(),
        status: 'checked'
      });
      
      checkStatus.textContent = `âœ… ãƒã‚§ãƒƒã‚¯å®Œäº†: ${foundItem.name}`;
      checkStatus.className = 'status-success';
      
      document.getElementById('check-result').className = 'check-result found';
      document.getElementById('check-result').innerHTML = `
        <div>âœ… <strong>${foundItem.name}</strong></div>
        <div style="font-size: 0.9em; margin-top: 0.3em;">è‡ªå‹•ã§ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ãŸ</div>
      `;
      
      if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
      
    } else {
      checkStatus.textContent = `â„¹ï¸ æ—¢ã«ãƒã‚§ãƒƒã‚¯æ¸ˆã¿: ${foundItem.name}`;
      checkStatus.className = 'status-warning';
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }
    
  } else {
    const anyItem = items.find(i => i.code === code);
    
    if (anyItem) {
      checkStatus.textContent = `âš ï¸ ${currentDay}æ›œæ—¥ã«ã¯ä¸è¦: ${anyItem.name}`;
      checkStatus.className = 'status-warning';
      
      document.getElementById('check-result').className = 'check-result not-found';
      document.getElementById('check-result').innerHTML = `
        <div>âš ï¸ <strong>${anyItem.name}</strong></div>
        <div style="font-size: 0.9em; margin-top: 0.3em;">${currentDay}æ›œæ—¥ã®ãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã›ã‚“</div>
      `;
    } else {
      checkStatus.textContent = `âŒ æœªç™»éŒ²ã‚¢ã‚¤ãƒ†ãƒ : ${code}`;
      checkStatus.className = 'status-error';
      
      document.getElementById('check-result').className = 'check-result not-found';
      document.getElementById('check-result').innerHTML = `
        <div>âŒ <strong>æœªç™»éŒ²ã‚¢ã‚¤ãƒ†ãƒ </strong></div>
        <div style="font-size: 0.9em; margin-top: 0.3em;">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: ${code}</div>
      `;
    }
    
    if (navigator.vibrate) navigator.vibrate([300, 100, 300]);
  }
  
  renderScanResults();
  
  setTimeout(() => {
    checkStatus.textContent = 'ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦è‡ªå‹•ãƒã‚§ãƒƒã‚¯';
    checkStatus.className = '';
    document.getElementById('check-result').className = 'check-result';
  }, 3000);
}

// ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åˆ¶å¾¡
function startScanning() {
  if (isScanning) return;
  status.textContent = 'ğŸ”§ ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ä¸­...';
  
  Quagga.init({...quaggaConfig, inputStream: {...quaggaConfig.inputStream, target: viewport}}, err => {
    if (err) {
      status.textContent = `âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ${err.message || err}`;
      return;
    }
    
    Quagga.start();
    isScanning = true;
    Quagga.onDetected(onDetected);
    status.textContent = 'ğŸ” ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ç·‘æ å†…ã«åˆã‚ã›ã¦ãã ã•ã„';
    scanBtn.disabled = true;
    stopBtn.disabled = false;
  });
}

function stopScanning() {
  if (!isScanning) return;
  Quagga.offDetected(onDetected);
  Quagga.stop();
  isScanning = false;
  status.textContent = 'â¹ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢';
  scanBtn.disabled = false;
  stopBtn.disabled = true;
}

function startCheckScanning() {
  if (isCheckScanning) return;
  checkStatus.textContent = 'ğŸ”§ ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ä¸­...';
  
  Quagga.init({...quaggaConfig, inputStream: {...quaggaConfig.inputStream, target: checkViewport}}, err => {
    if (err) {
      checkStatus.textContent = `âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ${err.message || err}`;
      return;
    }
    
    Quagga.start();
    isCheckScanning = true;
    Quagga.onDetected(onCheckDetected);
    checkStatus.textContent = 'ğŸ” ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ç·‘æ å†…ã«åˆã‚ã›ã¦ãã ã•ã„';
    checkScanBtn.disabled = true;
    checkStopBtn.disabled = false;
  });
}

function stopCheckScanning() {
  if (!isCheckScanning) return;
  Quagga.offDetected(onCheckDetected);
  Quagga.stop();
  isCheckScanning = false;
  checkStatus.textContent = 'â¹ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢';
  checkScanBtn.disabled = false;
  checkStopBtn.disabled = true;
}

scanBtn.addEventListener('click', startScanning);
stopBtn.addEventListener('click', stopScanning);
checkScanBtn.addEventListener('click', startCheckScanning);
checkStopBtn.addEventListener('click', stopCheckScanning);

// ã‚¹ã‚­ãƒ£ãƒ³çµæœè¡¨ç¤º
function renderScanResults() {
  const list = document.getElementById('scan-results');
  
  if (scanResults.size === 0) {
    list.innerHTML = '<li style="text-align:center; color:#999; padding:1em;">ã‚¹ã‚­ãƒ£ãƒ³çµæœãªã—</li>';
    return;
  }
  
  list.innerHTML = '';
  
  const sortedResults = Array.from(scanResults.entries())
    .sort(([,a], [,b]) => new Date(b.timestamp) - new Date(a.timestamp));
  
  sortedResults.forEach(([code, result]) => {
    const li = document.createElement('li');
    li.className = 'item scanned';
    
    const time = result.timestamp.toLocaleTimeString();
    const statusIcon = result.status === 'checked' ? 'âœ…' : 'âŒ';
    
    li.innerHTML = `
      <div style="display: flex; align-items: center; width: 100%;">
        <div style="margin-right: 0.8em; font-size: 1.2em;">${statusIcon}</div>
        <div style="flex: 1;">
          <div style="font-weight: 600;">${result.item ? result.item.name : 'æœªç™»éŒ²ã‚¢ã‚¤ãƒ†ãƒ '}</div>
          <div style="font-size: 0.8em; color: #666;">
            ${code} â€¢ ${time}
          </div>
        </div>
      </div>
    `;
    
    list.appendChild(li);
  });
}

// ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§è¡¨ç¤º
function renderItems() {
  const list = document.getElementById('items-list');
  const title = document.getElementById('items-title');
  
  let filtered = items;
  
  if (currentCategory !== 'all') {
    filtered = filtered.filter(i => i.category === currentCategory);
  }
  
  const searchTerm = document.getElementById('search-input').value.toLowerCase();
  if (searchTerm) {
    filtered = filtered.filter(i => 
      i.name.toLowerCase().includes(searchTerm) ||
      i.category.toLowerCase().includes(searchTerm) ||
      (i.code && i.code.toLowerCase().includes(searchTerm)) ||
      (i.memo && i.memo.toLowerCase().includes(searchTerm))
    );
  }
  
  filtered.sort((a, b) => {
    if (sortBy === 'name') return a.name.localeCompare(b.name);
    if (sortBy === 'category') return a.category.localeCompare(b.category);
    if (sortBy === 'priority') {
      const priorities = { 'å¿…é ˆ': 3, 'é‡è¦': 2, 'æ™®é€š': 1 };
      return priorities[b.priority] - priorities[a.priority];
    }
    if (sortBy === 'created') return new Date(b.createdAt) - new Date(a.createdAt);
    return 0;
  });
  
  title.textContent = `${getCategoryIcon(currentCategory)} ${currentCategory === 'all' ? 'å…¨ã‚¢ã‚¤ãƒ†ãƒ ' : currentCategory} (${filtered.length}ä»¶)`;
  
  if (filtered.length === 0) {
    list.innerHTML = '<li style="text-align:center; color:#999; padding:2em;">è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</li>';
    return;
  }
  
  list.innerHTML = '';
  filtered.forEach(item => {
    const li = createItemElement(item, false);
    list.appendChild(li);
  });
}

// ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¿ãƒ–
document.getElementById('category-tabs').addEventListener('click', e => {
  if (e.target.classList.contains('category-btn')) {
    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
    e.target.classList.add('active');
    currentCategory = e.target.dataset.category;
    renderItems();
  }
});

// æ¤œç´¢æ©Ÿèƒ½
const searchInput = document.getElementById('search-input');
const searchClear = document.getElementById('search-clear');

searchInput.addEventListener('input', () => {
  renderItems();
  searchClear.style.display = searchInput.value ? 'block' : 'none';
});

searchClear.addEventListener('click', () => {
  searchInput.value = '';
  searchClear.style.display = 'none';
  renderItems();
});

// ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ
document.getElementById('sort-toggle').addEventListener('click', () => {
  const sorts = ['name', 'category', 'priority', 'created'];
  const currentIndex = sorts.indexOf(sortBy);
  sortBy = sorts[(currentIndex + 1) % sorts.length];
  
  const labels = { name: 'åå‰é †', category: 'ã‚«ãƒ†ã‚´ãƒªãƒ¼é †', priority: 'é‡è¦åº¦é †', created: 'è¿½åŠ æ—¥é †' };
  document.getElementById('sort-toggle').textContent = `ğŸ“Š ${labels[sortBy]}`;
  
  renderItems();
});

// ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæ©Ÿèƒ½
function selectCurrentDay() {
  const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
  const today = days[new Date().getDay()];
  currentDay = today;
  
  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.day === today);
  });
  
  updateCheckDisplay();
}

// æ›œæ—¥é¸æŠ
document.getElementById('preset-days').addEventListener('click', e => {
  if (e.target.classList.contains('preset-btn')) {
    currentDay = e.target.dataset.day;
    
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.day === currentDay);
    });
    
    updateCheckDisplay();
    scanResults.clear();
    renderScanResults();
  }
});

// æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæ“ä½œ
document.getElementById('check-all').addEventListener('click', async () => {
  await performCheckAll();
});

document.getElementById('uncheck-all').addEventListener('click', async () => {
  await performUncheckAll();
});

document.getElementById('reset-check').addEventListener('click', async () => {
  await performResetCheck();
});

// ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæ“ä½œ
document.getElementById('scan-check-all').addEventListener('click', async () => {
  await performCheckAll();
});

document.getElementById('scan-uncheck-all').addEventListener('click', async () => {
  await performUncheckAll();
});

document.getElementById('scan-reset-check').addEventListener('click', async () => {
  await performResetCheck();
});

// å…±é€šãƒã‚§ãƒƒã‚¯æ“ä½œé–¢æ•°
async function performCheckAll() {
  const dayItems = items.filter(i => i.days.includes(currentDay));
  for (const item of dayItems) {
    if (!item.checked) {
      item.checked = true;
      await updateItem(item);
    }
  }
  updateCheckDisplay();
  updateStats();
  renderTodayChecklist();
  if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
}

async function performUncheckAll() {
  const dayItems = items.filter(i => i.days.includes(currentDay));
  for (const item of dayItems) {
    if (item.checked) {
      item.checked = false;
      await updateItem(item);
    }
  }
  updateCheckDisplay();
  updateStats();
  renderTodayChecklist();
}

async function performResetCheck() {
  if (confirm('å…¨ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
    for (const item of items) {
      item.checked = false;
      await updateItem(item);
    }
    renderItems();
    updateCheckDisplay();
    renderTodayChecklist();
    updateStats();
    scanResults.clear();
    renderScanResults();
    showStatus('ğŸ”„ ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
  }
}

// ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
function openEditModal(item) {
  editingItem = item;
  document.getElementById('edit-name').value = item.name;
  document.getElementById('edit-category').value = item.category;
  document.getElementById('edit-priority').value = item.priority;
  document.getElementById('edit-code').value = item.code || '';
  document.getElementById('edit-memo').value = item.memo || '';
  
  document.querySelectorAll('#edit-days input[type=checkbox]').forEach(cb => {
    cb.checked = item.days.includes(cb.value);
  });
  
  document.getElementById('edit-modal').classList.add('active');
}

function closeEditModal() {
  document.getElementById('edit-modal').classList.remove('active');
  editingItem = null;
}

document.getElementById('save-edit').addEventListener('click', async () => {
  if (!editingItem) return;
  
  const name = document.getElementById('edit-name').value.trim();
  if (!name) {
    showStatus('ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
    return;
  }
  
  const days = Array.from(document.querySelectorAll('#edit-days input[type=checkbox]:checked'))
                   .map(cb => cb.value);
  
  editingItem.name = name;
  editingItem.category = document.getElementById('edit-category').value;
  editingItem.priority = document.getElementById('edit-priority').value;
  editingItem.code = document.getElementById('edit-code').value.trim();
  editingItem.memo = document.getElementById('edit-memo').value.trim();
  editingItem.days = days;
  editingItem.updatedAt = new Date().toISOString();
  
  try {
    await updateItem(editingItem);
    renderItems();
    updateCheckDisplay();
    renderTodayChecklist();
    updateStats();
    closeEditModal();
    showStatus('âœ… æ›´æ–°ã—ã¾ã—ãŸ', 'success');
  } catch (err) {
    showStatus('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
  }
});

// å…¨å‰Šé™¤
document.getElementById('clear-items').addEventListener('click', async () => {
  if (confirm('æœ¬å½“ã«å…¨ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
    try {
      await clearItems();
      items = [];
      renderItems();
      renderTodayChecklist();
      updateStats();
      document.getElementById('checklist').innerHTML = '';
      document.getElementById('scan-checklist').innerHTML = '';
      scanResults.clear();
      renderScanResults();
      showStatus('ğŸ—‘ å…¨ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    } catch (err) {
      showStatus('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
    }
  }
});

// ãƒ‡ãƒ¼ã‚¿ç®¡ç†
document.getElementById('export-btn').addEventListener('click', async () => {
  try {
    const allItems = await getAllItems();
    const exportData = {
      items: allItems,
      exportedAt: new Date().toISOString(),
      version: '2.1',
      app: 'wasuremono-pro'
    };
    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `å¿˜ã‚Œç‰©é˜²æ­¢Pro_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showStatus('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
  } catch (err) {
    showStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
  }
});

document.getElementById('import-file').addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async () => {
    try {
      const data = JSON.parse(reader.result);
      const importItems = data.items || data;
      
      if (!Array.isArray(importItems)) {
        throw new Error('ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
      }
      
      if (confirm(`${importItems.length}ä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) {
        await clearItems();
        
        for (const item of importItems) {
          delete item.id;
          item.checked = false;
          if (!item.category) item.category = 'ãã®ä»–';
          if (!item.priority) item.priority = 'æ™®é€š';
          if (!item.days) item.days = [];
          await addItem(item);
        }
        
        await loadItems();
        scanResults.clear();
        renderScanResults();
        showStatus(`âœ… ${importItems.length}ä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');
      }
    } catch (err) {
      showStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
});

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ
document.getElementById('backup-btn').addEventListener('click', async () => {
  try {
    const allItems = await getAllItems();
    localStorage.setItem('wasuremono-backup', JSON.stringify({
      items: allItems,
      backupAt: new Date().toISOString()
    }));
    showStatus('ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
  } catch (err) {
    showStatus('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
  }
});

document.getElementById('restore-btn').addEventListener('click', async () => {
  try {
    const backup = localStorage.getItem('wasuremono-backup');
    if (!backup) {
      showStatus('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
      return;
    }
    
    const data = JSON.parse(backup);
    if (confirm(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆ${new Date(data.backupAt).toLocaleString()}ï¼‰ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
      await clearItems();
      
      for (const item of data.items) {
        delete item.id;
        await addItem(item);
      }
      
      await loadItems();
      scanResults.clear();
      renderScanResults();
      showStatus('ğŸ”„ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ', 'success');
    }
  } catch (err) {
    showStatus('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
  }
});

// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
async function loadItems() {
  try {
    items = await getAllItems();
    renderItems();
    renderTodayChecklist();
    updateStats();
  } catch (err) {
    console.error('Load items failed:', err);
  }
}

// PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
let deferredPrompt;
const installBtn = document.getElementById('install-pwa');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'inline-block';
});

installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) {
    showStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
    return;
  }
  
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  
  if (outcome === 'accepted') {
    installBtn.style.display = 'none';
    showStatus('ğŸ“± PWAãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸ', 'success');
  }
  
  deferredPrompt = null;
});

// åˆæœŸåŒ–
openDB().then(async () => {
  await loadItems();
  selectCurrentDay();
  
  if (items.length === 0) {
    setTimeout(() => {
      showStatus('ğŸ‘‹ ã‚ˆã†ã“ãï¼ã¾ãšã¯æ•™æã‚„æŒã¡ç‰©ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†', 'info');
    }, 1000);
  }
});

// ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
window.addEventListener('beforeunload', () => {
  if (isScanning) stopScanning();
  if (isCheckScanning) stopCheckScanning();
});

</script>
</body>
</html>
