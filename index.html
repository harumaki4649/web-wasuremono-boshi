<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ“š å¿˜ã‚Œç‰©é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ </title>
<meta name="theme-color" content="#007bff">

<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #f8f9fa; padding: 0.5em; line-height: 1.6;
  }
  .container { max-width: 480px; margin: 0 auto; }
  header {
    background: #007bff; color: white; padding: 1em;
    border-radius: 12px; text-align: center; margin-bottom: 1em;
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
  }
  .tab-nav {
    display: flex; background: white; border-radius: 8px;
    margin-bottom: 1em; overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .tab-btn {
    flex: 1; padding: 0.8em; border: none; background: white;
    cursor: pointer; font-weight: 500; transition: all 0.2s;
  }
  .tab-btn.active { background: #007bff; color: white; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .card {
    background: white; border-radius: 12px; padding: 1.2em;
    margin-bottom: 1em; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  #viewport {
    position: relative; width: 100%; height: 250px;
    border: 2px solid #007bff; border-radius: 12px;
    overflow: hidden; background: #000; margin-bottom: 1em;
  }
  video { width: 100%; height: 100%; object-fit: cover; }
  .guide {
    position: absolute; top: 20%; left: 15%; right: 15%; bottom: 20%;
    border: 3px dashed #00ff00; background: rgba(0,255,0,0.1);
    pointer-events: none; border-radius: 8px;
  }
  .btn {
    padding: 0.8em 1.5em; border: none; border-radius: 8px;
    font-weight: 600; cursor: pointer; transition: all 0.2s;
    margin: 0.3em; display: inline-block; text-decoration: none;
    text-align: center; font-size: 14px;
  }
  .btn-primary { background: #007bff; color: white; }
  .btn-secondary { background: #6c757d; color: white; }
  .btn-success { background: #28a745; color: white; }
  .btn-danger { background: #dc3545; color: white; }
  .btn:disabled { background: #ccc; cursor: not-allowed; }
  .input-group { margin-bottom: 1em; }
  .input-group label { display: block; margin-bottom: 0.3em; font-weight: 500; }
  .input-group input, .input-group select, .input-group textarea {
    width: 100%; padding: 0.7em; border: 2px solid #ddd;
    border-radius: 8px; font-size: 14px;
  }
  .input-group input:focus, .input-group select:focus {
    outline: none; border-color: #007bff;
  }
  .item-list { list-style: none; padding-left: 0; }
  .item {
    display: flex; align-items: center; padding: 0.8em;
    border: 2px solid #e9ecef; border-radius: 8px;
    margin-bottom: 0.5em; transition: all 0.2s;
  }
  .item.checked {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    border-color: #28a745;
  }
  .item-info { flex: 1; margin-left: 0.8em; }
  .item-name { font-weight: 600; color: #333; }
  .item-code { font-size: 0.8em; color: #666; }
  .item-day { font-size: 0.8em; color: #007bff; font-weight: 500; }
  .preset-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 0.5em; margin-bottom: 1em;
  }
  .preset-btn {
    padding: 0.6em; border: 2px solid #007bff; background: white;
    color: #007bff; border-radius: 8px; cursor: pointer;
    font-weight: 500; transition: all 0.2s; text-align: center;
  }
  .preset-btn.active { background: #007bff; color: white; }
  #status {
    padding: 0.8em; border-radius: 8px; margin-bottom: 1em;
    text-align: center; font-weight: 500;
    background: #e3f2fd; color: #1976d2; border: 2px solid #bbdefb;
  }
  .export-import { display: flex; gap: 0.5em; margin-top: 1em; }
  .file-input { display: none; }
  .install-btn {
    position: fixed; bottom: 20px; right: 20px; z-index: 1000;
    background: #28a745; color: white; border: none; border-radius: 50px;
    padding: 0.8em 1.2em; font-weight: 600; box-shadow: 0 4px 12px rgba(40,167,69,0.4);
    display: none;
  }
  @media (max-width: 480px) {
    body { padding: 0.3em; }
    .tab-btn { padding: 0.6em; font-size: 13px; }
    .btn { padding: 0.6em 1.2em; font-size: 13px; }
  }
</style>

</head>
<body>
<div class="container">
<header>
<h1>ğŸ“š å¿˜ã‚Œç‰©é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ </h1>
<p>æ•™æã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã€å¿˜ã‚Œç‰©ã‚’ã‚¼ãƒ­ã«ï¼</p>
</header>

<nav class="tab-nav">
<button class="tab-btn active" data-tab="scanner">ğŸ“± ã‚¹ã‚­ãƒ£ãƒ³</button>
<button class="tab-btn" data-tab="items">ğŸ“‹ æ•™æä¸€è¦§</button>
<button class="tab-btn" data-tab="check">âœ… ãƒã‚§ãƒƒã‚¯</button>
<button class="tab-btn" data-tab="settings">âš™ï¸ è¨­å®š</button>
</nav>

<div id="scanner" class="tab-content active">
<div class="card">
<div id="viewport"><div class="guide"></div></div>
<div id="status">ğŸ“· æº–å‚™å®Œäº† - ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
<div style="text-align: center;">
<button id="scan-btn" class="btn btn-primary">ğŸš€ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
<button id="stop-btn" class="btn btn-secondary" disabled>â¹ åœæ­¢</button>
</div>
</div>

<div class="card">
<h3>ğŸ“– æ•™æã‚’æ‰‹å‹•è¿½åŠ </h3>
<div class="input-group">
<label>æ•™æå</label>
<input type="text" id="manual-name" placeholder="ä¾‹: æ•°å­¦ã®æ•™ç§‘æ›¸">
</div>
<div class="input-group">
<label>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ (ä»»æ„)</label>
<input type="text" id="manual-code" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã¾ãŸã¯ç‹¬è‡ªID">
</div>
<div class="input-group">
<label>å¿…è¦ãªæ›œæ—¥</label>
<div style="display: flex; flex-wrap: wrap; gap: 0.3em;">
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="æœˆ" style="margin-right: 0.3em;"> æœˆ</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="ç«" style="margin-right: 0.3em;"> ç«</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="æ°´" style="margin-right: 0.3em;"> æ°´</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="æœ¨" style="margin-right: 0.3em;"> æœ¨</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="é‡‘" style="margin-right: 0.3em;"> é‡‘</label>
<label style="display: flex; align-items: center; margin-right: 1em;"><input type="checkbox" value="åœŸ" style="margin-right: 0.3em;"> åœŸ</label>
<label style="display: flex; align-items: center;"><input type="checkbox" value="æ—¥" style="margin-right: 0.3em;"> æ—¥</label>
</div>
</div>
<button id="add-manual" class="btn btn-success">â• è¿½åŠ </button>
</div>
</div>

<div id="items" class="tab-content">
<div class="card">
<h3>ğŸ“š ç™»éŒ²æ¸ˆã¿æ•™æ</h3>
<ul id="items-list" class="item-list"></ul>
<div style="text-align: center; margin-top: 1em;">
<button id="clear-items" class="btn btn-danger">ğŸ—‘ å…¨å‰Šé™¤</button>
</div>
</div>
</div>

<div id="check" class="tab-content">
<div class="card">
<h3>âœ… æ›œæ—¥åˆ¥ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
<div class="preset-grid" id="preset-days">
<button class="preset-btn" data-day="æœˆ">æœˆ</button>
<button class="preset-btn" data-day="ç«">ç«</button>
<button class="preset-btn" data-day="æ°´">æ°´</button>
<button class="preset-btn" data-day="æœ¨">æœ¨</button>
<button class="preset-btn" data-day="é‡‘">é‡‘</button>
<button class="preset-btn" data-day="åœŸ">åœŸ</button>
<button class="preset-btn" data-day="æ—¥">æ—¥</button>
</div>
<ul id="checklist" class="item-list"></ul>
<div style="text-align: center; margin-top: 1em;">
<button id="reset-check" class="btn btn-secondary">ğŸ”„ ãƒã‚§ãƒƒã‚¯ãƒªã‚»ãƒƒãƒˆ</button>
</div>
</div>
</div>

<div id="settings" class="tab-content">
<div class="card">
<h3>âš™ï¸ è¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
<div class="export-import">
<button id="export-btn" class="btn btn-primary">â¬‡ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
<label for="import-file" class="btn btn-secondary" style="margin-bottom:0;">â¬† ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</label>
<input type="file" id="import-file" class="file-input" accept="application/json">
</div>
<div id="status-msg" style="margin-top:1em; text-align:center; color:#28a745; font-weight:600;"></div>
</div>
<div class="card">
<h3>ğŸ“± PWAã«ã¤ã„ã¦</h3>
<p>ã“ã®ã‚¢ãƒ—ãƒªã¯PWAï¼ˆProgressive Web Appï¼‰ã¨ã—ã¦å‹•ä½œã—ã¾ã™ã€‚</p>
<ul style="margin-top:0.5em; padding-left:1.5em;">
<li>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚å‹•ä½œ</li>
<li>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ å¯èƒ½</li>
<li>ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜</li>
</ul>
<button id="install-pwa" class="btn btn-success" style="margin-top:1em; display:none;">ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </button>
</div>
</div>
</div>

<button id="install-btn-float" class="install-btn">ğŸ“± ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
// PWA manifest data (inline)
const manifestData = {
  "name": "å¿˜ã‚Œç‰©é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ ",
  "short_name": "å¿˜ã‚Œç‰©ãƒã‚§ãƒƒã‚¯",
  "description": "æ•™æã‚’ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ã—ã€å¿˜ã‚Œç‰©ã‚’é˜²ãPWAã‚·ã‚¹ãƒ†ãƒ ",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#007bff",
  "orientation": "portrait",
  "icons": [
    {
      "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==",
      "sizes": "512x512", 
      "type": "image/png"
    }
  ]
};

// Create and set manifest
const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(manifestBlob);
const link = document.createElement('link');
link.rel = 'manifest';
link.href = manifestURL;
document.head.appendChild(link);

// Register service worker (inline)
const swCode = `
const CACHE_NAME = 'wasuremono-v1';
const urlsToCache = [
  './',
  'https://unpkg.com/quagga@0.12.1/dist/quagga.min.js'
];

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME).then(cache => {
      return cache.addAll(urlsToCache).catch(() => {
        // Offline install - cache current page only
        return cache.add('./');
      });
    })
  );
});

self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request).then(response => {
      return response || fetch(event.request).catch(() => {
        // Return cached version if network fails
        return caches.match('./');
      });
    })
  );
});
`;

if ('serviceWorker' in navigator) {
  const swBlob = new Blob([swCode], {type: 'application/javascript'});
  const swURL = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swURL).then(() => {
    console.log('Service Worker registered');
  }).catch(err => {
    console.error('SW registration failed:', err);
  });
}

// IndexedDB wrapper
const DB_NAME = 'wasuremonoDB';
const DB_VERSION = 1;
const STORE_NAME = 'items';
let db;

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
      }
    };
  });
}

function addItem(item) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const request = store.add(item);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function getAllItems() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

function clearItems() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const request = store.clear();
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

function updateItem(item) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const request = store.put(item);
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

// UI Elements
const tabs = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
const itemsList = document.getElementById('items-list');
const checklist = document.getElementById('checklist');
const presetDays = document.getElementById('preset-days');
const statusMsg = document.getElementById('status-msg');
const status = document.getElementById('status');

// State
let items = [];
let currentDay = null;

// Tab switching
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    const target = tab.dataset.tab;
    tabContents.forEach(tc => {
      tc.classList.toggle('active', tc.id === target);
    });
  });
});

// Render items list
function renderItems() {
  itemsList.innerHTML = '';
  if (items.length === 0) {
    itemsList.innerHTML = '<li style="text-align:center; color:#999; padding:2em;">ç™»éŒ²ã•ã‚ŒãŸæ•™æãŒã‚ã‚Šã¾ã›ã‚“</li>';
    return;
  }
  items.forEach(item => {
    const li = document.createElement('li');
    li.className = 'item' + (item.checked ? ' checked' : '');
    li.dataset.id = item.id;

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = !!item.checked;
    checkbox.addEventListener('change', async () => {
      item.checked = checkbox.checked;
      await updateItem(item);
      renderItems();
      if (currentDay) renderChecklist(currentDay);
    });

    const info = document.createElement('div');
    info.className = 'item-info';
    info.innerHTML = `
      <div class="item-name">${item.name}</div>
      <div class="item-code">${item.code || '(ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãªã—)'}</div>
      <div class="item-day">${item.days.join(', ')}</div>
    `;

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'ğŸ—‘';
    deleteBtn.className = 'btn btn-danger';
    deleteBtn.style.cssText = 'padding:0.3em 0.6em; margin:0; font-size:12px;';
    deleteBtn.addEventListener('click', async () => {
      if (confirm(`ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        await deleteItem(item.id);
        items = items.filter(i => i.id !== item.id);
        renderItems();
        if (currentDay) renderChecklist(currentDay);
      }
    });

    li.appendChild(checkbox);
    li.appendChild(info);
    li.appendChild(deleteBtn);
    itemsList.appendChild(li);
  });
}

function deleteItem(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const request = store.delete(id);
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

// Render checklist for a day
function renderChecklist(day) {
  checklist.innerHTML = '';
  currentDay = day;
  
  // Update preset button states
  presetDays.querySelectorAll('.preset-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.day === day);
  });
  
  const filtered = items.filter(i => i.days.includes(day));
  if (filtered.length === 0) {
    checklist.innerHTML = '<li style="text-align:center; color:#999; padding:2em;">ãã®æ—¥ã®æ•™æã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</li>';
    return;
  }
  
  const checkedCount = filtered.filter(i => i.checked).length;
  const totalCount = filtered.length;
  
  // Progress indicator
  const progressDiv = document.createElement('div');
  progressDiv.style.cssText = 'text-align:center; margin-bottom:1em; font-weight:600;';
  progressDiv.innerHTML = `
    <div style="color: ${checkedCount === totalCount ? '#28a745' : '#007bff'};">
      ${checkedCount}/${totalCount} å®Œäº† ${checkedCount === totalCount ? 'ğŸ‰' : ''}
    </div>
  `;
  checklist.appendChild(progressDiv);
  
  filtered.forEach(item => {
    const li = document.createElement('li');
    li.className = 'item' + (item.checked ? ' checked' : '');
    li.dataset.id = item.id;

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = !!item.checked;
    checkbox.addEventListener('change', async () => {
      item.checked = checkbox.checked;
      await updateItem(item);
      renderChecklist(day);
      renderItems();
      
      // Celebration effect
      if (checkbox.checked && navigator.vibrate) {
        navigator.vibrate([100, 50, 100]);
      }
    });

    const info = document.createElement('div');
    info.className = 'item-info';
    info.innerHTML = `
      <div class="item-name">${item.name}</div>
      <div class="item-code">${item.code || '(ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãªã—)'}</div>
    `;

    li.appendChild(checkbox);
    li.appendChild(info);
    checklist.appendChild(li);
  });
}

// Add new item
async function addNewItem(name, code, days) {
  if (!name.trim()) return;
  
  // Check for duplicate codes
  if (code && items.some(i => i.code === code)) {
    alert('åŒã˜ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®æ•™æãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
    return;
  }
  
  const item = { 
    name: name.trim(), 
    code: code.trim() || null, 
    days: days || [], 
    checked: false,
    createdAt: new Date().toISOString()
  };
  
  try {
    item.id = await addItem(item);
    items.push(item);
    renderItems();
    if (currentDay && days.includes(currentDay)) renderChecklist(currentDay);
    return true;
  } catch (err) {
    alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
    return false;
  }
}

// Clear all items
async function clearAllItems() {
  try {
    await clearItems();
    items = [];
    renderItems();
    checklist.innerHTML = '';
    currentDay = null;
  } catch (err) {
    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
  }
}

// Load all items from DB
async function loadItems() {
  try {
    items = await getAllItems();
    renderItems();
  } catch (err) {
    console.error('Load items failed:', err);
  }
}

// Preset day buttons
presetDays.querySelectorAll('.preset-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    renderChecklist(btn.dataset.day);
  });
});

// Auto-select current day
function selectCurrentDay() {
  const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
  const today = days[new Date().getDay()];
  const todayFiltered = items.filter(i => i.days.includes(today));
  if (todayFiltered.length > 0) {
    renderChecklist(today);
  }
}

// Barcode scanning setup
const scanBtn = document.getElementById('scan-btn');
const stopBtn = document.getElementById('stop-btn');
const viewport = document.getElementById('viewport');
let isScanning = false;

const quaggaConfig = {
  inputStream: {
    name: 'Live',
    type: 'LiveStream',
    target: viewport,
    constraints: {
      facingMode: 'environment',
      width: { min: 640, ideal: 800, max: 1280 },
      height: { min: 480, ideal: 600, max: 720 }
    },
    area: { top: '20%', right: '15%', left: '15%', bottom: '20%' },
    willReadFrequently: true
  },
  frequency: 8,
  numOfWorkers: 2,
  decoder: {
    readers: ['ean_reader', 'ean_8_reader'],
    multiple: false
  },
  locate: true,
  locator: { patchSize: 'medium', halfSample: false },
  debug: { drawBoundingBox: true, showFrequency: false, drawScanline: true, showPattern: false }
};

function onDetected(result) {
  const code = result.codeResult.code;
  if (!code || !/^\d{13}$/.test(code)) return;
  
  // Check if code already exists
  const existing = items.find(i => i.code === code);
  if (existing) {
    status.textContent = `âœ… æ—¢ã«ç™»éŒ²æ¸ˆã¿: ${existing.name} (${code})`;
    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    return;
  }
  
  status.textContent = `ğŸ“– æ¤œå‡º: ${code} - æ•™æåã‚’å…¥åŠ›ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„`;
  document.getElementById('manual-code').value = code;
  document.getElementById('manual-name').focus();
  
  if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
}

function startScanning() {
  if (isScanning) return;
  status.textContent = 'ğŸ”§ ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ä¸­...';
  
  Quagga.init(quaggaConfig, err => {
    if (err) {
      status.textContent = `âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ${err.message || err}`;
      console.error(err);
      return;
    }
    
    Quagga.start();
    isScanning = true;
    Quagga.onDetected(onDetected);
    status.textContent = 'ğŸ” ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ç·‘æ å†…ã«åˆã‚ã›ã¦ãã ã•ã„';
    scanBtn.disabled = true;
    stopBtn.disabled = false;
  });
}

function stopScanning() {
  if (!isScanning) return;
  Quagga.offDetected(onDetected);
  Quagga.stop();
  isScanning = false;
  status.textContent = 'â¹ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢';
  scanBtn.disabled = false;
  stopBtn.disabled = true;
}

scanBtn.addEventListener('click', startScanning);
stopBtn.addEventListener('click', stopScanning);

// Add manual item
const addManualBtn = document.getElementById('add-manual');
addManualBtn.addEventListener('click', async () => {
  const name = document.getElementById('manual-name').value;
  const code = document.getElementById('manual-code').value;
  const dayCheckboxes = document.querySelectorAll('#scanner input[type=checkbox]:checked');
  const days = Array.from(dayCheckboxes).map(cb => cb.value);
  
  if (!name.trim()) {
    alert('æ•™æåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    document.getElementById('manual-name').focus();
    return;
  }
  
  if (days.length === 0) {
    alert('å¿…è¦ãªæ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  
  const success = await addNewItem(name, code, days);
  if (success) {
    document.getElementById('manual-name').value = '';
    document.getElementById('manual-code').value = '';
    dayCheckboxes.forEach(cb => cb.checked = false);
    status.textContent = `âœ… ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`;
  }
});

// Enter key support for manual input
document.getElementById('manual-name').addEventListener('keypress', e => {
  if (e.key === 'Enter') addManualBtn.click();
});

// Clear items
const clearItemsBtn = document.getElementById('clear-items');
clearItemsBtn.addEventListener('click', async () => {
  if (confirm('æœ¬å½“ã«å…¨ã¦ã®æ•™æã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
    await clearAllItems();
    status.textContent = 'ğŸ—‘ å…¨ã¦ã®æ•™æã‚’å‰Šé™¤ã—ã¾ã—ãŸ';
  }
});

// Reset check status
const resetCheckBtn = document.getElementById('reset-check');
resetCheckBtn.addEventListener('click', async () => {
  if (confirm('å…¨ã¦ã®æ•™æã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
    for (const item of items) {
      item.checked = false;
      await updateItem(item);
    }
    renderItems();
    if (currentDay) renderChecklist(currentDay);
    status.textContent = 'ğŸ”„ ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ';
  }
});

// Export and import
const exportBtn = document.getElementById('export-btn');
const importFile = document.getElementById('import-file');

exportBtn.addEventListener('click', async () => {
  try {
    const allItems = await getAllItems();
    const exportData = {
      items: allItems,
      exportedAt: new Date().toISOString(),
      version: '1.0'
    };
    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `å¿˜ã‚Œç‰©é˜²æ­¢ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    statusMsg.textContent = 'âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ';
    setTimeout(() => statusMsg.textContent = '', 3000);
  } catch (err) {
    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
  }
});

importFile.addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async () => {
    try {
      const data = JSON.parse(reader.result);
      const importItems = data.items || data; // æ–°æ—§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¯¾å¿œ
      
      if (!Array.isArray(importItems)) {
        throw new Error('ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
      }
      
      if (confirm(`${importItems.length}ä»¶ã®æ•™æã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) {
        await clearAllItems();
        
        for (const item of importItems) {
          delete item.id; // æ–°è¦IDã‚’ä»˜ä¸
          item.checked = false; // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã¯ãƒªã‚»ãƒƒãƒˆ
          await addItem(item);
        }
        
        await loadItems();
        statusMsg.textContent = `âœ… ${importItems.length}ä»¶ã®æ•™æã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`;
        setTimeout(() => statusMsg.textContent = '', 3000);
      }
    } catch (err) {
      alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
    }
  };
  reader.readAsText(file);
  e.target.value = '';
});

// PWA install functionality
let deferredPrompt;
const installBtn = document.getElementById('install-pwa');
const installBtnFloat = document.getElementById('install-btn-float');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'inline-block';
  installBtnFloat.style.display = 'block';
});

[installBtn, installBtnFloat].forEach(btn => {
  btn.addEventListener('click', async () => {
    if (!deferredPrompt) {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
      console.log('PWA install accepted');
      installBtn.style.display = 'none';
      installBtnFloat.style.display = 'none';
    }
    
    deferredPrompt = null;
  });
});

// Initialize app
openDB().then(async () => {
  await loadItems();
  selectCurrentDay();
  
  // Show welcome message for first-time users
  if (items.length === 0) {
    setTimeout(() => {
      status.textContent = 'ğŸ‘‹ åˆå›åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã¾ãšã¯æ•™æã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†';
    }, 1000);
  }
});

// Cleanup when page unloads
window.addEventListener('beforeunload', () => {
  if (isScanning) {
    stopScanning();
  }
});

</script>
</body>
</html>
